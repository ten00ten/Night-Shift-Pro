<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Night Shift Pro</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>tailwind.config = { darkMode: 'media' }</script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; touch-action: manipulation; }
        ::-webkit-scrollbar { display: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .msg-bubble { max-width: 75%; word-wrap: break-word; }
        .ad-banner { display: none; } 
        .profile-img { object-fit: cover; }
        .news-item { transition: all 0.2s; }
        .news-item:active { transform: scale(0.98); opacity: 0.8; }
        /* 未確定シフトの点滅アニメーション */
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .6; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <div id="app" class="h-screen w-screen overflow-hidden flex flex-col">
        
        <div v-if="isLoading" class="fixed inset-0 z-[9999] bg-white dark:bg-gray-900 flex flex-col items-center justify-center gap-4">
            <div class="animate-spin h-10 w-10 border-4 border-blue-500 border-t-transparent rounded-full"></div>
            <p class="text-xs text-gray-400">Loading...</p>
        </div>

        <div v-if="!isLoading && isFirstRun" class="fixed inset-0 z-50 bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6">
            <i class="fa-solid fa-cloud text-6xl text-blue-500 mb-6"></i>
            <h1 class="text-2xl font-bold mb-2">Night Shift Pro</h1>
            <p class="text-gray-500 dark:text-gray-400 text-center mb-8 text-sm">クラウド接続完了。<br>最初の店舗アカウントを作成します。</p>
            <div class="w-full max-w-sm space-y-4 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                <input v-model="newStoreName" placeholder="店舗名" class="w-full p-4 bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 rounded-xl">
                <input v-model="newStoreEmail" type="email" placeholder="メールアドレス (通知先)" class="w-full p-4 bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 rounded-xl">
                <button @click="registerStore" :disabled="!newStoreName || !newStoreEmail" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg disabled:opacity-50">アカウント作成</button>
            </div>
        </div>

        <div v-else-if="!isLoggedIn" class="flex-1 flex flex-col overflow-y-auto bg-gray-50 dark:bg-gray-900">
            <div class="mt-20 flex flex-col items-center justify-center space-y-4 px-6">
                <i class="fa-solid fa-moon text-blue-500 text-7xl drop-shadow-lg"></i>
                <h1 class="text-3xl font-black text-gray-900 dark:text-white">Night Shift Pro</h1>
                <div class="bg-gray-200 dark:bg-gray-800 px-4 py-1 rounded-full text-sm font-bold text-gray-600 dark:text-gray-300">{{ isStaffLoginMode ? '店舗管理者' : 'キャスト' }}ログイン</div>
            </div>
            
            <div class="px-8 mt-6 space-y-6">
                <form v-if="isStaffLoginMode" @submit.prevent="loginStaff" class="space-y-4">
                    <input v-model="staffIdInput" type="text" autocomplete="username" placeholder="管理者ID" class="w-full p-4 rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800">
                    <input v-model="staffPassInput" type="password" autocomplete="current-password" placeholder="パスワード" class="w-full p-4 rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg">管理画面へ</button>
                </form>
                
                <form v-else @submit.prevent="loginCast" class="space-y-4">
                    <input v-model="storeIdInput" type="text" autocomplete="on" placeholder="店舗ID" class="w-full p-4 rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 uppercase">
                    <input v-model="castCodeInput" type="text" autocomplete="on" placeholder="キャストコード" class="w-full p-4 rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 uppercase">
                    <button type="submit" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg">ログイン</button>
                </form>

                <div class="text-center mt-4"><button type="button" @click="isStaffLoginMode=!isStaffLoginMode" class="text-sm text-gray-500 underline">{{ isStaffLoginMode ? 'キャストの方' : '店舗管理者の方' }}</button></div>
                <div class="text-center mt-8"><button type="button" @click="showRegisterModal=true" class="text-xs text-blue-500 font-bold">店舗を新規作成する</button></div>
            </div>
        </div>

        <div v-else class="flex-1 flex flex-col h-full relative bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">
            <header class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border-b dark:border-gray-700 px-4 py-3 pt-12 shadow-sm flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center space-x-2">
                    <button v-if="viewingChatId" @click="closeChat" class="text-blue-500 mr-1"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 class="font-bold text-lg truncate max-w-[200px]">{{ pageTitle }}</h2>
                </div>
                <div v-if="activeCast" class="text-xs font-mono bg-pink-100 dark:bg-pink-900 text-pink-800 dark:text-pink-100 px-2 py-1 rounded">{{ activeCast.name }}</div>
                <div v-if="!activeCast" class="text-xs font-mono bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100 px-2 py-1 rounded">店舗管理者</div>
            </header>

            <main class="flex-1 overflow-y-auto pb-24 px-4 py-4" ref="mainScroll">
                
                <div v-if="currentTab==='staff-home' && !viewingChatId">
                    <div v-if="absenceShifts.length > 0" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-xl shadow-sm mb-6 animate-pulse">
                        <h3 class="font-bold text-red-600 dark:text-red-400 mb-2"><i class="fa-solid fa-triangle-exclamation"></i> 欠勤・遅刻の連絡</h3>
                        <div v-for="shift in absenceShifts" :key="shift.id" class="bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm mb-2 border-l-4 border-red-500">
                            <div class="flex justify-between font-bold"><span>{{ shift.castName }}</span><span class="text-red-500">欠勤</span></div>
                            <div class="text-xs text-gray-500 mt-1">{{ formatDate(shift.date) }}</div>
                            <div class="flex gap-2 mt-2"><button @click="updateShift(shift,'承認済み')" class="flex-1 bg-red-500 text-white py-2 rounded text-xs font-bold">確認 (承認)</button></div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-4">
                        <h3 class="font-bold text-gray-500 dark:text-gray-400 mb-2"><i class="fa-solid fa-calendar-check mr-2"></i>本日の出勤 ({{ todayShifts.length }}名)</h3>
                        <div v-if="todayShifts.length===0" class="text-xs text-gray-400 text-center py-2">出勤予定はありません</div>
                        <div class="flex flex-col gap-2">
                            <div v-for="s in todayShifts" :key="s.id" class="flex items-center gap-3 bg-blue-50 dark:bg-gray-700 p-2 rounded-lg">
                                <img v-if="getCastIcon(s.castId)" :src="getCastIcon(s.castId)" class="w-8 h-8 rounded-full profile-img bg-white">
                                <div v-else class="w-8 h-8 bg-blue-200 rounded-full flex center items-center justify-center text-blue-500 text-xs"><i class="fa-solid fa-user"></i></div>
                                <div class="flex-1 font-bold text-sm">{{ s.castName }}</div>
                                <div class="text-xs font-mono bg-white dark:bg-gray-600 px-2 py-1 rounded">{{ s.startTime }}-{{ s.endTime }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-500 dark:text-gray-400">最新のお知らせ</h3>
                            <button @click="showAnnouncementModal=true" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold">投稿</button>
                        </div>
                        <div v-if="sortedAnnouncements.length===0" class="text-xs text-gray-400 text-center">お知らせはありません</div>
                        <div v-for="(news, i) in sortedAnnouncements.slice(0,3)" :key="i" @click="openNews(news)" class="news-item cursor-pointer text-sm border-b dark:border-gray-700 pb-2 mb-2 last:border-0 last:mb-0">
                            <div class="flex justify-between text-xs text-gray-400"><span>{{ formatDate(news.date) }}</span><span v-if="i===0" class="bg-red-100 text-red-500 px-1 rounded text-[10px]">NEW</span></div>
                            <div class="mt-1 font-medium truncate">{{ news.text }}</div>
                        </div>
                        <div class="text-center mt-2"><button @click="currentTab='news'" class="text-xs text-blue-500">すべて見る</button></div>
                    </div>

                    <div class="text-sm text-gray-500 font-bold mb-2">承認待ちシフト</div>
                    <div v-if="pendingShifts.length===0" class="text-center py-6 text-gray-400 text-sm">なし</div>
                    <div v-for="shift in pendingShifts" :key="shift.id" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-3 border-l-4 border-blue-500">
                        <div class="flex justify-between font-bold mb-1"><span>{{ shift.castName }}</span><span>{{ formatDate(shift.date) }}</span></div>
                        <div class="text-xs mb-2 bg-blue-50 text-blue-600 px-2 py-1 rounded inline-block">{{ shift.type }} {{ shift.startTime }}-{{ shift.endTime }}</div>
                        <div v-if="shift.note" class="text-xs text-gray-500 bg-gray-50 p-2 rounded mb-2">{{ shift.note }}</div>
                        <div class="flex gap-2"><button @click="updateShift(shift,'却下')" class="flex-1 bg-gray-100 text-red-500 py-2 rounded text-xs font-bold">却下</button><button @click="updateShift(shift,'承認済み')" class="flex-1 bg-blue-600 text-white py-2 rounded text-xs font-bold">承認</button></div>
                    </div>
                </div>

                <div v-if="currentTab==='news' && !viewingChatId">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
                        <h3 class="font-bold mb-4 text-lg">お知らせ一覧</h3>
                        <div v-if="sortedAnnouncements.length===0" class="text-gray-400 text-center py-10">お知らせはありません</div>
                        <div v-for="(news, i) in sortedAnnouncements" :key="i" @click="openNews(news)" class="news-item cursor-pointer border-b dark:border-gray-700 py-4 last:border-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs text-gray-400">{{ formatDate(news.date) }}</span>
                                <div v-if="activeCast">
                                    <span v-if="news.readBy?.includes(activeCast.id)" class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full font-bold">✅ 確認済</span>
                                    <span v-else class="text-[10px] bg-red-100 text-red-500 px-2 py-0.5 rounded-full font-bold">未読</span>
                                </div>
                                <button v-if="!activeCast" @click.stop="deleteAnnouncement(news)" class="text-red-400 text-xs"><i class="fa-solid fa-trash"></i> 削除</button>
                            </div>
                            <div class="font-bold text-sm whitespace-pre-wrap">{{ news.text }}</div>
                        </div>
                    </div>
                </div>

                <div v-if="(currentTab==='staff-calendar' || currentTab==='cast-calendar') && !viewingChatId">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-4 mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <button @click="changeMonth(-1)" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700"><i class="fa-solid fa-chevron-left"></i></button>
                            <div class="text-center">
                                <h3 class="font-bold text-lg">{{ currentMonthDisplay }}</h3>
                                <button @click="goToToday" class="text-xs text-blue-500 font-bold bg-blue-50 px-2 py-0.5 rounded mt-1">今日に戻る</button>
                            </div>
                            <button @click="changeMonth(1)" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>

                        <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs text-gray-400"><span>日</span>...<span>土</span></div>
                        <div class="grid grid-cols-7 gap-2">
                            <div v-for="day in calendarDays" :key="day.dateStr" @click="selectDate(day.dateStr)" class="aspect-square flex flex-col items-center justify-center rounded-lg border relative cursor-pointer" 
                                :class="isSameDay(day.dateStr, selectedDate) ? 'border-pink-500 bg-pink-50 dark:bg-pink-900/30' : (day.isCurrentMonth ? 'border-transparent bg-gray-50 dark:bg-gray-700' : 'border-transparent bg-gray-100/50 dark:bg-gray-800/50 text-gray-400')">
                                <span class="text-sm" :class="{'font-bold text-blue-600': isSameDay(day.dateStr, todayStr)}">{{ new Date(day.dateStr).getDate() }}</span>
                                
                                <div class="h-1 mt-1 flex gap-0.5">
                                    <div v-if="activeCast && getMyShift(day.dateStr)" class="w-1.5 h-1.5 rounded-full" :class="getShiftColor(getMyShift(day.dateStr))"></div>
                                </div>
                                <div v-if="!activeCast && getStaffCount(day.dateStr)>0" class="absolute bottom-0 right-0 text-[8px] bg-blue-100 text-blue-600 px-1 rounded-tl">{{ getStaffCount(day.dateStr) }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 min-h-[200px]">
                        <h4 class="font-bold text-lg mb-4 border-b pb-2 flex justify-between">
                            <span>{{ formatDate(selectedDate) }}</span>
                            <span v-if="activeCast && getMyShift(selectedDate)" class="text-sm px-2 py-1 rounded" :class="getShiftColor(getMyShift(selectedDate)) + ' text-white'">
                                {{ getMyShift(selectedDate).status }}
                            </span>
                        </h4>

                        <div v-if="!activeCast">
                            <div v-if="getDailyShifts(selectedDate).length===0" class="text-gray-400 text-center py-4">出勤予定はありません</div>
                            <div v-for="s in getDailyShifts(selectedDate)" :key="s.id" class="flex items-center gap-3 py-3 border-b dark:border-gray-700 last:border-0">
                                <img v-if="getCastIcon(s.castId)" :src="getCastIcon(s.castId)" class="w-10 h-10 rounded-full profile-img bg-gray-200">
                                <div v-else class="w-10 h-10 bg-gray-200 rounded-full flex center items-center justify-center text-gray-400"><i class="fa-solid fa-user"></i></div>
                                <div class="flex-1">
                                    <div class="font-bold">{{ s.castName }}</div>
                                    <div class="text-xs text-gray-400">実績: {{ Object.keys(s.backs||{}).length }}件</div>
                                </div>
                                <div class="text-sm bg-blue-50 text-blue-600 px-2 py-1 rounded font-mono">{{ s.startTime }} - {{ s.endTime }}</div>
                            </div>
                        </div>

                        <div v-else>
                            <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg mb-4"><button v-for="t in ['出勤','休み','要相談']" @click="editingShift.type=t" class="flex-1 py-2 text-sm rounded-md font-bold" :class="editingShift.type===t?'bg-white shadow text-black':'text-gray-400'">{{ t }}</button></div>
                            <div v-if="editingShift.type==='出勤'">
                                <div class="flex gap-2 mb-4"><input v-model="editingShift.startTime" type="time" class="flex-1 p-2 border rounded dark:bg-gray-700"><input v-model="editingShift.endTime" type="time" class="flex-1 p-2 border rounded dark:bg-gray-700"></div>
                                <div v-if="storeData.backOptions?.length > 0" class="mb-4 space-y-2">
                                    <label class="text-xs text-gray-500 font-bold">本日の実績</label>
                                    <div v-for="opt in storeData.backOptions" :key="opt.id" class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded">
                                        <span class="text-xs">{{ opt.name }}</span>
                                        <input type="number" v-model="editingShift.backs[opt.id]" placeholder="0" class="w-16 p-1 text-right rounded border dark:border-gray-600 bg-white dark:bg-gray-800 text-sm">
                                    </div>
                                </div>
                            </div>
                            <input v-model="editingShift.note" placeholder="備考" class="w-full p-3 border rounded mb-4 dark:bg-gray-700">
                            <button @click="submitShift" class="w-full bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg">保存</button>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab==='staff-casts'">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-500">キャスト</h3><div class="flex gap-2"><button @click="showBackSettings=true" class="text-xs bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded font-bold">バック設定</button><button @click="addCast" class="text-blue-600 font-bold text-sm">追加</button></div></div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden"><div v-for="(cast, i) in storeData.casts" :key="cast.id" class="p-4 border-b dark:border-gray-700 flex justify-between items-center"><div class="flex items-center gap-3"><img v-if="cast.icon" :src="cast.icon" class="w-10 h-10 rounded-full profile-img bg-gray-200"><div v-else class="w-10 h-10 bg-gray-200 rounded-full flex center items-center justify-center"><i class="fa-solid fa-user text-gray-400"></i></div><div><div class="font-bold">{{ cast.name }}</div><div class="text-xs text-gray-400 font-mono">{{ cast.code }}</div></div></div><div class="flex gap-3"><button @click="showQRCode(cast)" class="text-blue-400"><i class="fa-solid fa-qrcode"></i></button><button @click="deleteCast(cast)" class="text-red-400"><i class="fa-solid fa-trash"></i></button></div></div></div>
                </div>

                <div v-if="currentTab==='messages' && !viewingChatId && !activeCast">
                    <div v-for="c in storeData.casts" :key="c.id" @click="openChat(c.id, c.name)" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm flex items-center gap-3 mb-2 cursor-pointer"><img v-if="c.icon" :src="c.icon" class="w-12 h-12 rounded-full profile-img bg-gray-200"><div v-else class="w-12 h-12 bg-pink-100 rounded-full flex center justify-center items-center"><i class="fa-solid fa-user text-pink-500"></i></div><div class="flex-1"><div class="font-bold">{{ c.name }}</div><div class="text-xs text-gray-500 truncate">{{ getLastMsg(c.id) }}</div></div><div v-if="getUnreadCount(c.id)>0" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">{{ getUnreadCount(c.id) }}</div></div>
                </div>
                <div v-if="viewingChatId || (activeCast && currentTab==='messages')" class="flex flex-col gap-4 pb-4"><div v-if="currentMessages.length===0" class="text-center text-gray-400 text-sm mt-10">メッセージなし</div><div v-for="m in currentMessages" :key="m.id" class="flex flex-col" :class="isMyMessage(m)?'items-end':'items-start'"><div class="msg-bubble px-4 py-2 rounded-2xl text-sm" :class="isMyMessage(m)?(activeCast?'bg-pink-500 text-white':'bg-blue-500 text-white'):'bg-white dark:bg-gray-800 shadow-sm'">{{ m.text }}</div><span class="text-[10px] text-gray-400 mt-1 flex gap-1"><span v-if="isMyMessage(m) && m.isRead" class="text-blue-400">既読</span>{{ formatTime(m.timestamp) }}</span></div></div>

                <div v-if="currentTab==='settings'">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm mb-6 p-4"><div class="flex items-center gap-4 mb-4"><div class="relative w-16 h-16"><img v-if="activeCast?.icon || storeData.icon" :src="activeCast ? activeCast.icon : storeData.icon" class="w-16 h-16 rounded-full profile-img bg-gray-200"><div v-else class="w-16 h-16 bg-gray-200 rounded-full flex center items-center justify-center text-2xl"><i class="fa-solid fa-user text-gray-400"></i></div><label class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs cursor-pointer shadow"><i class="fa-solid fa-camera"></i><input type="file" class="hidden" accept="image/*" @change="uploadIcon"></label></div><div><div class="font-bold text-lg">{{ activeCast ? activeCast.name : storeData.storeName }}</div><div class="text-xs text-gray-400 font-mono select-all">ID: {{ activeCast ? activeCast.code : storeData.storeDisplayId }}</div></div></div><div v-if="!activeCast" class="mb-4"><label class="text-xs font-bold text-gray-500">通知用メールアドレス</label><input v-model="storeData.storeEmail" @change="updateStore({storeEmail:storeData.storeEmail})" placeholder="欠勤連絡を受け取るアドレス" class="w-full p-2 border rounded dark:bg-gray-700 text-sm mt-1"></div><div v-if="activeCast" class="p-4 border-t dark:border-gray-700 space-y-4"><div class="flex justify-between items-center"><span class="text-sm font-bold">給与概算を表示</span><button @click="toggleSalaryDisplay" class="w-10 h-5 bg-gray-300 rounded-full relative" :class="{'bg-green-500':activeCast.settings?.showSalary}"><div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-all" :class="{'left-6':activeCast.settings?.showSalary}"></div></button></div><div v-if="activeCast.settings?.showSalary"><label class="text-xs text-gray-500">基本時給</label><div class="flex items-center gap-2"><input type="number" v-model="activeCast.settings.hourlyRate" @change="saveCastSettings" class="p-2 border rounded w-24 bg-gray-50 dark:bg-gray-700 text-right"><span class="text-sm">円</span></div></div></div><div class="border-t dark:border-gray-700 pt-2 mt-2"><button @click="showHelpModal='usage'" class="w-full text-left py-3 text-sm flex justify-between items-center"><span>使い方ガイド</span><i class="fa-solid fa-chevron-right text-xs text-gray-400"></i></button><button @click="showHelpModal='terms'" class="w-full text-left py-3 text-sm flex justify-between items-center"><span>利用規約</span><i class="fa-solid fa-chevron-right text-xs text-gray-400"></i></button><button @click="openFeedback" class="w-full text-left py-3 text-sm flex justify-between items-center"><span>不具合報告・フィードバック</span><i class="fa-solid fa-envelope text-xs text-gray-400"></i></button></div><button @click="logout" class="w-full text-left py-2 text-red-500 font-bold border-t dark:border-gray-700 pt-4 mt-2">ログアウト</button></div>
                </div>
            </main>

            <div v-if="viewingChatId || (activeCast && currentTab==='messages')" class="bg-white dark:bg-gray-800 p-3 border-t dark:border-gray-700 safe-area-bottom flex gap-2"><input v-model="chatInput" placeholder="入力..." class="flex-1 bg-gray-100 dark:bg-gray-700 p-3 rounded-full dark:text-white"><button @click="sendMessage" :disabled="!chatInput" class="text-blue-500"><i class="fa-solid fa-paper-plane text-xl"></i></button></div>
            
            <nav v-if="!viewingChatId" class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 safe-area-bottom px-4 py-2 flex justify-between text-xs text-gray-400 z-20">
                <template v-if="!activeCast">
                    <button @click="currentTab='staff-home'" :class="{'text-blue-600':currentTab==='staff-home'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-house text-xl"></i><span class="text-[9px]">ホーム</span></button>
                    <button @click="currentTab='staff-calendar'; goToToday()" :class="{'text-blue-600':currentTab==='staff-calendar'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-calendar-days text-xl"></i><span class="text-[9px]">シフト</span></button>
                    <button @click="currentTab='messages'" :class="{'text-blue-600':currentTab==='messages'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-message text-xl"></i><span class="text-[9px]">トーク</span></button>
                    <button @click="currentTab='news'" :class="{'text-blue-600':currentTab==='news'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-bullhorn text-xl"></i><span class="text-[9px]">お知らせ</span></button>
                    <button @click="currentTab='staff-casts'" :class="{'text-blue-600':currentTab==='staff-casts'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-users text-xl"></i><span class="text-[9px]">キャスト</span></button>
                    <button @click="currentTab='settings'" :class="{'text-blue-600':currentTab==='settings'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-gear text-xl"></i><span class="text-[9px]">設定</span></button>
                </template>
                <template v-else>
                    <button @click="markChatRead(); currentTab='cast-calendar'; goToToday()" :class="{'text-pink-500':currentTab==='cast-calendar'}" class="flex flex-col items-center w-16 gap-1"><i class="fa-solid fa-calendar-days text-xl"></i>シフト</button>
                    <button @click="markChatRead(); currentTab='messages'" :class="{'text-pink-500':currentTab==='messages'}" class="flex flex-col items-center w-16 gap-1 relative"><i class="fa-solid fa-message text-xl"></i>トーク<span v-if="totalUnread>0" class="absolute top-0 right-3 w-2 h-2 bg-red-500 rounded-full"></span></button>
                    <button @click="markChatRead(); currentTab='news'" :class="{'text-pink-500':currentTab==='news'}" class="flex flex-col items-center w-16 gap-1 relative"><i class="fa-solid fa-bullhorn text-xl"></i>お知らせ</button>
                    <button @click="markChatRead(); currentTab='settings'" :class="{'text-pink-500':currentTab==='settings'}" class="flex flex-col items-center w-16 gap-1"><i class="fa-solid fa-gear text-xl"></i>設定</button>
                </template>
            </nav>
        </div>

        <div v-if="showAnnouncementModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl"><h3 class="font-bold mb-4">お知らせ投稿</h3><textarea v-model="newAnnouncementText" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg h-32 mb-4"></textarea><div class="flex gap-3"><button @click="showAnnouncementModal=false" class="flex-1 py-3 text-gray-500">キャンセル</button><button @click="postAnnouncement" class="flex-1 bg-blue-600 text-white rounded-lg font-bold">投稿</button></div></div></div>
        <div v-if="showRegisterModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl"><h3 class="font-bold mb-4">新規店舗登録</h3><input v-model="newStoreName" placeholder="店舗名" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg mb-4"><input v-model="newStoreEmail" type="email" placeholder="メールアドレス" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg mb-4"><div class="flex gap-3"><button @click="showRegisterModal=false" class="flex-1 py-3 text-gray-500">キャンセル</button><button @click="registerStore" class="flex-1 bg-blue-600 text-white rounded-lg font-bold">作成</button></div></div></div>
        <div v-if="showBackSettings" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl h-[70vh] flex flex-col"><h3 class="font-bold mb-4">バック設定</h3><div class="flex-1 overflow-y-auto space-y-2 mb-4"><div v-for="(opt, i) in storeData.backOptions" :key="i" class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded"><span>{{ opt.name }} (¥{{ opt.price }})</span><button @click="deleteBackOption(opt)" class="text-red-400"><i class="fa-solid fa-trash"></i></button></div></div><div class="border-t pt-4 space-y-2"><input v-model="newBackName" placeholder="項目名" class="w-full p-2 border rounded dark:bg-gray-700"><input v-model="newBackPrice" type="number" placeholder="単価" class="w-full p-2 border rounded dark:bg-gray-700"><button @click="addBackOption" class="w-full bg-blue-600 text-white py-2 rounded font-bold">追加</button><button @click="showBackSettings=false" class="w-full text-gray-500 mt-2">閉じる</button></div></div></div>
        <div v-if="selectedNews" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl"><div class="text-xs text-gray-400 mb-2">{{ formatDate(selectedNews.date) }}</div><div class="whitespace-pre-wrap font-medium mb-6 dark:text-gray-100 max-h-[50vh] overflow-y-auto">{{ selectedNews.text }}</div><div v-if="activeCast"><button v-if="!selectedNews.readBy?.includes(activeCast.id)" @click="confirmNews" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">確認しました</button><button v-else class="w-full bg-gray-200 dark:bg-gray-700 text-gray-500 font-bold py-3 rounded-xl" disabled>確認済み</button></div><button @click="selectedNews=null" class="mt-3 w-full text-gray-500 py-2">閉じる</button></div></div>
        <div v-if="showQRModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl text-center"><h3 class="font-bold mb-2">{{ qrTargetName }}</h3><p class="text-xs text-gray-400 mb-4">このQRコードを読み取ってログイン</p><div class="flex justify-center mb-4"><img :src="`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrUrl)}`" alt="QR Code" class="border rounded p-2 bg-white"></div><button @click="showQRModal=false" class="py-2 px-6 bg-blue-600 text-white rounded-lg">閉じる</button></div></div>
        <div v-if="showHelpModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl h-[70vh] flex flex-col"><h3 class="font-bold mb-4">{{ showHelpModal==='terms'?'利用規約':'使い方ガイド' }}</h3><div class="flex-1 overflow-y-auto text-sm space-y-3 text-gray-600 dark:text-gray-300"><template v-if="showHelpModal==='terms'"><p>1. 本アプリはベータ版です。データの消失等について責任を負いません。</p><p>2. 入力されたデータはFirebase(Google)に保存されます。</p><p>3. アカウント情報は適切に管理してください。</p></template><template v-else><p><strong>【店舗管理者】</strong><br>・キャストを追加してID/QRを渡してください。<br>・シフトの承認/却下ができます。</p><p><strong>【キャスト】</strong><br>・カレンダーから希望シフトを提出します。<br>・「設定」で時給を登録すると給与目安が出ます。</p></template></div><button @click="showHelpModal=null" class="mt-4 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg">閉じる</button></div></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyD932E1eO3VTLQR49mibJFm-jks2xtVf0c", authDomain: "night-shift-pro.firebaseapp.com", projectId: "night-shift-pro", storageBucket: "night-shift-pro.firebasestorage.app", messagingSenderId: "98250749733", appId: "1:98250749733:web:167c5f6cc6a2e901160ccc", measurementId: "G-7CFY2WW6TG" };
        
        // ★★★ あなたのEmailJS ID ★★★
        const emailConfig = { 
            publicKey: "pBXsfa-38OMNK1E6b", 
            serviceId: "service_71f25g6", 
            templateId: "template_675u7wq", 
            notificationTemplateId: "Template_36z9afr" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        if(window.emailjs) emailjs.init(emailConfig.publicKey);

        const { createApp, ref, computed, reactive, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const isLoading = ref(true);
                const storeData = ref({ casts:[], shifts:[], messages:[], announcements:[], backOptions:[] });
                const isLoggedIn = ref(false);
                const isStaffLoginMode = ref(false);
                const currentTab = ref('staff-home');
                const viewingChatId = ref(null);
                const staffIdInput=ref(''); const staffPassInput=ref('');
                const storeIdInput=ref(''); const castCodeInput=ref('');
                const newStoreName=ref(''); const newStoreEmail=ref('');
                const chatInput=ref(''); const mainScroll=ref(null);
                const currentStoreDocId = ref(null);
                const currentCastId = ref(null);
                
                // カレンダー用変数
                const currentMonth = ref(new Date());
                const selectedDate = ref(new Date().toISOString().split('T')[0]);
                const editingShift = reactive({type:'出勤',startTime:'20:00',endTime:'25:00',note:'', backs:{}});
                
                const showAnnouncementModal=ref(false); const newAnnouncementText=ref('');
                const showRegisterModal=ref(false); const showBackSettings=ref(false);
                const newBackName=ref(''); const newBackPrice=ref('');
                const showQRModal=ref(false); const qrUrl=ref(''); const qrTargetName=ref('');
                const showHelpModal=ref(null); const isFirstRun = ref(false);
                const selectedNews = ref(null);

                const generateRandomId = (prefix, length) => { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return prefix + result; };
                const generateRandomPass = () => Math.random().toString(36).slice(-8);

                let unsubscribe = null;
                const subscribeToStore = (docId) => {
                    if(unsubscribe) unsubscribe();
                    unsubscribe = onSnapshot(doc(db, "stores", docId), (d) => {
                        if(d.exists()) {
                            storeData.value = d.data();
                            if(!storeData.value.backOptions) storeData.value.backOptions = [];
                        }
                    });
                };
                const checkFirstRun = async () => { const q = query(collection(db, "stores")); const snap = await getDocs(q); isFirstRun.value = snap.empty; isLoading.value = false; };

                onMounted(async () => {
                    const params = new URLSearchParams(window.location.search);
                    const sId = params.get('store'); const cCode = params.get('code');
                    if(sId && cCode) {
                        isLoading.value = true;
                        const q = query(collection(db, "stores"), where("storeDisplayId", "==", sId));
                        const snap = await getDocs(q);
                        if(!snap.empty) {
                            const d = snap.docs[0]; const data = d.data(); const cast = data.casts.find(c => c.code === cCode);
                            if(cast) { currentStoreDocId.value = d.id; currentCastId.value = cast.id; subscribeToStore(d.id); isLoggedIn.value = true; currentTab.value = 'cast-calendar'; window.history.replaceState(null, '', window.location.pathname); }
                        }
                    }
                    checkFirstRun();
                });

                const updateStore = async (data) => { if(currentStoreDocId.value) await updateDoc(doc(db, "stores", currentStoreDocId.value), data); };
                
                // カレンダーロジック
                const calendarDays = computed(() => {
                    const year = currentMonth.value.getFullYear();
                    const month = currentMonth.value.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const days = [];
                    // パディング(前月分)
                    for(let i=0; i<firstDay.getDay(); i++) days.push({ dateStr: '', isCurrentMonth: false });
                    // 今月分
                    for(let i=1; i<=lastDay.getDate(); i++) {
                        const d = new Date(year, month, i);
                        const str = d.toISOString().split('T')[0];
                        days.push({ dateStr: str, isCurrentMonth: true });
                    }
                    return days;
                });
                const changeMonth = (n) => { const d = new Date(currentMonth.value); d.setMonth(d.getMonth() + n); currentMonth.value = d; };
                const goToToday = () => { currentMonth.value = new Date(); selectedDate.value = new Date().toISOString().split('T')[0]; };
                const currentMonthDisplay = computed(() => `${currentMonth.value.getFullYear()}年 ${currentMonth.value.getMonth() + 1}月`);
                const todayStr = computed(() => new Date().toISOString().split('T')[0]);

                const getShiftColor = (s) => {
                    if(!s) return '';
                    if(s.type==='欠勤') return 'bg-purple-500';
                    if(s.type==='休み') return 'bg-red-500';
                    if(s.status==='承認待ち') return 'bg-blue-300 animate-pulse-slow'; // 未確定(点滅)
                    return 'bg-blue-500'; // 確定
                };

                const selectDate=(d)=>{ if(!d) return; selectedDate.value=d; const s=getMyShift(d); editingShift.type=s?s.type:'出勤'; editingShift.startTime=s?s.startTime:'20:00'; editingShift.endTime=s?s.endTime:'25:00'; editingShift.note=s?s.note:''; editingShift.backs = s && s.backs ? {...s.backs} : {}; };
                const getMyShift=(d)=>storeData.value.shifts.find(s=>s.date===d && s.castId===currentCastId.value);
                const getCastIcon = (cid) => { const c = storeData.value.casts.find(x=>x.id===cid); return c ? c.icon : null; };

                // お知らせロジック (新着順ソート)
                const sortedAnnouncements = computed(() => {
                    if(!storeData.value.announcements) return [];
                    return [...storeData.value.announcements].sort((a,b) => new Date(b.date) - new Date(a.date));
                });

                const markChatRead = async () => { /* (省略: 変更なし) */ };
                const openNews = (news) => { selectedNews.value = news; };
                const postAnnouncement = async () => { if(newAnnouncementText.value) { const news = { id: Date.now().toString(), text: newAnnouncementText.value, date: new Date().toISOString(), readBy: [] }; await updateStore({ announcements: arrayUnion(news) }); showAnnouncementModal.value=false; newAnnouncementText.value=''; } };
                const deleteAnnouncement = async (news) => { await updateStore({ announcements: arrayRemove(news) }); };
                const confirmNews = async () => {
                    if(!selectedNews.value || !activeCast.value) return;
                    const oldNews = storeData.value.announcements.find(n => n.id === selectedNews.value.id);
                    if(oldNews) { const newNews = JSON.parse(JSON.stringify(oldNews)); if(!newNews.readBy) newNews.readBy = []; if(!newNews.readBy.includes(activeCast.value.id)) newNews.readBy.push(activeCast.value.id); await updateStore({ announcements: arrayRemove(oldNews) }); await updateStore({ announcements: arrayUnion(newNews) }); selectedNews.value = null; }
                };

                // その他の関数 (変更なし)
                const registerStore = async () => {
                    if(!newStoreName.value || !newStoreEmail.value) { alert("店舗名とメールアドレスを入力してください"); return; }
                    isLoading.value = true;
                    const id = generateRandomId('ST-', 8); const adm = generateRandomId('ADM-', 8); const pass = generateRandomPass();
                    try {
                        await addDoc(collection(db, "stores"), { storeName: newStoreName.value, storeDisplayId: id, staffLoginId: adm, staffPassword: pass, casts: [], shifts: [], messages: [], announcements: [], backOptions: [], storeEmail: newStoreEmail.value });
                        if(window.emailjs) { const params = { to_name: newStoreName.value, to_email: newStoreEmail.value, store_id: id, admin_id: adm, password: pass }; await emailjs.send(emailConfig.serviceId, emailConfig.templateId, params); }
                        alert(`登録完了！メールを送信しました。\n店舗ID: ${id}\n管理者ID: ${adm}\nPass: ${pass}`);
                        newStoreName.value = ''; newStoreEmail.value = ''; showRegisterModal.value = false; checkFirstRun();
                    } catch(e) { alert("エラー: " + e.message); }
                    isLoading.value = false;
                };
                const loginStaff = async () => { isLoading.value = true; const q = query(collection(db, "stores"), where("staffLoginId", "==", staffIdInput.value), where("staffPassword", "==", staffPassInput.value)); const snap = await getDocs(q); if(!snap.empty) { const d = snap.docs[0]; currentStoreDocId.value = d.id; currentCastId.value = null; subscribeToStore(d.id); isLoggedIn.value = true; currentTab.value = 'staff-home'; } else { alert("IDまたはパスワードが違います"); } isLoading.value = false; };
                const loginCast = async () => { isLoading.value = true; const q = query(collection(db, "stores"), where("storeDisplayId", "==", storeIdInput.value.toUpperCase())); const snap = await getDocs(q); if(!snap.empty) { const d = snap.docs[0]; const data = d.data(); const cast = data.casts.find(c => c.code === castCodeInput.value.toUpperCase()); if(cast) { currentStoreDocId.value = d.id; currentCastId.value = cast.id; subscribeToStore(d.id); isLoggedIn.value = true; currentTab.value = 'cast-calendar'; markChatRead(); } else { alert("キャストコードが見つかりません"); } } else { alert("店舗IDが見つかりません"); } isLoading.value = false; };
                const logout = () => { isLoggedIn.value=false; currentStoreDocId.value=null; currentCastId.value=null; if(unsubscribe) unsubscribe(); };
                const addCast = async () => { const n = prompt("名前"); if(n) { const code = generateRandomId('C-', 6); const newCast = { id: Date.now().toString(), name: n, code: code, settings:{hourlyRate:2000, showSalary:true} }; await updateStore({ casts: arrayUnion(newCast) }); alert(`キャストを追加しました。\nコード: ${code}`); } };
                const deleteCast = async (cast) => { if(confirm("削除しますか？")) await updateStore({ casts: arrayRemove(cast) }); };
                const addBackOption = async () => { if(newBackName.value && newBackPrice.value) { await updateStore({ backOptions: arrayUnion({ id:Date.now().toString(), name:newBackName.value, price:parseInt(newBackPrice.value) }) }); newBackName.value=''; newBackPrice.value=''; }};
                const deleteBackOption = async (opt) => { await updateStore({ backOptions: arrayRemove(opt) }); };
                const submitShift = async () => { const s = getMyShift(selectedDate.value); if(s) await updateStore({ shifts: arrayRemove(s) }); const newShift = { id: Date.now().toString(), date: selectedDate.value, castId: currentCastId.value, castName: activeCast.value.name, status: '承認待ち', ...editingShift, backs:{...editingShift.backs} }; await updateStore({ shifts: arrayUnion(newShift) }); alert("保存しました"); };
                const updateShift = async (s, st) => { await updateStore({ shifts: arrayRemove(s) }); const newS = {...s, status: st}; await updateStore({ shifts: arrayUnion(newS) }); };
                const reportAbsence = async () => { 
                    if(confirm("店長に欠勤・遅刻の連絡をしますか？\n（メール通知が送られます）")) { 
                        selectDate(new Date().toISOString().split('T')[0]); editingShift.type='欠勤'; await submitShift(); 
                        await sendMessageText('【自動連絡】欠勤・遅刻の連絡をしました', true);
                        if(storeData.value.storeEmail && window.emailjs) {
                            const params = { to_email: storeData.value.storeEmail, subject: `【欠勤連絡】${activeCast.value.name}さんから連絡があります`, message: `${activeCast.value.name}さんが本日の欠勤・遅刻を報告しました。\nアプリを確認してください。` };
                            try { await emailjs.send(emailConfig.serviceId, emailConfig.notificationTemplateId, params); alert("店長へメール通知を送信しました。"); } catch(e) {}
                        }
                    } 
                };
                const sendMessage = () => sendMessageText(chatInput.value, !!activeCast.value);
                const sendMessageText = async (txt, isCast) => { if(!txt) return; const tid = isCast ? activeCast.value.id : viewingChatId.value; const msg = { id:Date.now().toString(), text:txt, isSenderCast:isCast, timestamp:new Date().toISOString(), castId:tid, isRead:false }; await updateStore({ messages: arrayUnion(msg) }); chatInput.value=''; };
                const uploadIcon = async (e) => { const file = e.target.files[0]; if(file && file.size < 100000) { const reader = new FileReader(); reader.onload = async (e) => { const base64 = e.target.result; if(activeCast.value) { const newCast = JSON.parse(JSON.stringify(activeCast.value)); newCast.icon = base64; await updateStore({ casts: arrayRemove(activeCast.value) }); await updateStore({ casts: arrayUnion(newCast) }); } else { await updateStore({ icon: base64 }); } }; reader.readAsDataURL(file); } else { alert("画像サイズが大きすぎます (100KB以下)"); } };
                const openChat = (cid, n) => { viewingChatId.value=cid; markChatRead(); };
                const closeChat = () => { viewingChatId.value = null; };
                const activeCast = computed(()=>storeData.value.casts.find(c=>c.id===currentCastId.value));
                const pageTitle = computed(()=>activeCast.value?'Cast':'店舗管理者');
                const pendingShifts = computed(()=>storeData.value.shifts.filter(s=>s.status==='承認待ち' && s.type!=='欠勤').sort((a,b)=>new Date(a.date)-new Date(b.date)));
                const absenceShifts = computed(()=>storeData.value.shifts.filter(s=>s.status==='承認待ち' && s.type==='欠勤').sort((a,b)=>new Date(a.date)-new Date(b.date)));
                const currentMessages = computed(()=>{ const tid = activeCast.value ? activeCast.value.id : viewingChatId.value; return storeData.value.messages.filter(m=>m.castId===tid).sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp)); });
                const totalUnread = computed(()=> { if(!activeCast.value) return 0; return storeData.value.messages.filter(m=>m.castId===activeCast.value.id && !m.isSenderCast && !m.isRead).length; });
                const getUnreadCount = (cid) => storeData.value.messages.filter(m=>m.castId===cid && m.isSenderCast && !m.isRead).length;
                const todayShifts = computed(() => { const today = new Date().toISOString().split('T')[0]; return storeData.value.shifts.filter(s => s.date === today && s.type === '出勤' && s.status === '承認済み'); });
                const getStaffCount = (date) => storeData.value.shifts.filter(s => s.date === date && s.type === '出勤' && s.status === '承認済み').length;
                const getDailyShifts = (date) => storeData.value.shifts.filter(s => s.date === date && s.type === '出勤' && s.status === '承認済み');
                const salaryInfo = computed(() => { if(!activeCast.value) return {confirmed:0, pending:0}; const thisMonth = new Date().getMonth(); const myShifts = storeData.value.shifts.filter(s => s.castId === currentCastId.value && new Date(s.date).getMonth() === thisMonth && s.type === '出勤'); const hourly = activeCast.value.settings?.hourlyRate || 0; const backOpts = storeData.value.backOptions || []; const calc = (shifts) => { let total = 0; shifts.forEach(s => { const start = parseInt(s.startTime.split(':')[0]) + parseInt(s.startTime.split(':')[1])/60; const end = parseInt(s.endTime.split(':')[0]) + parseInt(s.endTime.split(':')[1])/60; total += (end - start) * hourly; if(s.backs) { Object.keys(s.backs).forEach(oid=>{const c=parseInt(s.backs[oid]); const o=backOpts.find(x=>x.id===oid); if(o) total+=c*o.price;}); } }); return Math.floor(total); }; return { confirmed: calc(myShifts.filter(s => s.status === '承認済み')), pending: calc(myShifts.filter(s => s.status === '承認待ち')) }; });
                const toggleSalaryDisplay=async()=>{ const newCast = JSON.parse(JSON.stringify(activeCast.value)); if(!newCast.settings) newCast.settings={hourlyRate:2000, showSalary:true}; newCast.settings.showSalary = !newCast.settings.showSalary; await updateStore({ casts: arrayRemove(activeCast.value) }); await updateStore({ casts: arrayUnion(newCast) }); };
                const saveCastSettings=async()=>{ const newCast = JSON.parse(JSON.stringify(activeCast.value)); await updateStore({ casts: arrayRemove(activeCast.value) }); await updateStore({ casts: arrayUnion(newCast) }); };
                const showQRCode=(c)=>{ qrTargetName.value=c.name; qrUrl.value=`${window.location.origin}${window.location.pathname}?store=${storeData.value.storeDisplayId}&code=${c.code}`; showQRModal.value=true; };
                const openFeedback = () => { window.location.href = `mailto:NightShiftPro.app@gmail.com?subject=NightShiftPro不具合報告&body=店舗ID:${storeData.value.storeDisplayId}`; };
                const formatDate=(d)=>new Date(d).toLocaleDateString('ja-JP',{month:'numeric',day:'numeric',weekday:'short'});
                const formatTime=(t)=>t.includes('T') ? new Date(t).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}) : t;
                const isSameDay=(a,b)=>a===b;
                const getLastMsg=(cid)=>{const m=storeData.value.messages.filter(x=>x.castId===cid);return m.length?m[m.length-1].text:'';};
                const isMyMessage=(m)=>{if(activeCast.value)return m.isSenderCast;return !m.isSenderCast;};

                return { isLoading, isFirstRun, isLoggedIn, isStaffLoginMode, currentTab, viewingChatId, staffIdInput, staffPassInput, storeIdInput, castCodeInput, newStoreName, newStoreEmail, chatInput, storeData, activeCast, pageTitle, pendingShifts, absenceShifts, calendarDays, selectedDate, currentMonthDisplay, editingShift, currentMessages, registerStore, loginStaff, loginCast, logout, showAnnouncementModal, newAnnouncementText, postAnnouncement, deleteAnnouncement, showRegisterModal, showBackSettings, newBackName, newBackPrice, addBackOption, deleteBackOption, selectDate, changeMonth, goToToday, todayStr, getShiftColor, getMyShift, getDailyShifts, submitShift, updateShift, reportAbsence, openChat, closeChat, sendMessage, isMyMessage, getLastMsg, formatTime, formatDate, isSameDay, salaryInfo, toggleSalaryDisplay, saveCastSettings, addCast, deleteCast, showQRModal, qrUrl, qrTargetName, showQRCode, showHelpModal, openFeedback, totalUnread, getUnreadCount, todayShifts, getStaffCount, getCastIcon, uploadIcon, selectedNews, openNews, confirmNews, markChatRead, updateStore, sortedAnnouncements };
            }
        }).mount('#app');
    </script>
</body>
</html>
