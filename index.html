<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Night Shift Pro</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.body.innerHTML = '<div style="padding:20px; color:red; font-weight:bold;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>' + msg + '<br>è¡Œ: ' + line + '</div>';
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>tailwind.config = { darkMode: 'media' }</script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; touch-action: manipulation; }
        ::-webkit-scrollbar { display: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .msg-bubble { max-width: 75%; word-wrap: break-word; }
        .profile-img { object-fit: cover; }
        .news-item { transition: all 0.2s; }
        .news-item:active { transform: scale(0.98); opacity: 0.8; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .6; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <div id="app" class="h-screen w-screen overflow-hidden flex flex-col">
        
        <div v-if="isLoading" class="fixed inset-0 z-[9999] bg-white dark:bg-gray-900 flex flex-col items-center justify-center gap-4">
            <div class="animate-spin h-10 w-10 border-4 border-blue-500 border-t-transparent rounded-full"></div>
            <p class="text-xs text-gray-400">Loading...</p>
        </div>

        <div v-if="!isLoading && isFirstRun" class="fixed inset-0 z-50 bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6">
            <i class="fa-solid fa-cloud text-6xl text-blue-500 mb-6"></i>
            <h1 class="text-2xl font-bold mb-2">Night Shift Pro</h1>
            <p class="text-gray-500 dark:text-gray-400 text-center mb-8 text-sm">ã‚¯ãƒ©ã‚¦ãƒ‰æ¥ç¶šå®Œäº†ã€‚<br>æœ€åˆã®åº—èˆ—ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚</p>
            <div class="w-full max-w-sm space-y-4 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                <input v-model="newStoreName" placeholder="åº—èˆ—å" class="w-full p-4 bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 rounded-xl">
                <input v-model="newStoreEmail" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (é€šçŸ¥å…ˆ)" class="w-full p-4 bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 rounded-xl">
                <button @click="registerStore" :disabled="!newStoreName || !newStoreEmail" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg disabled:opacity-50">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
            </div>
        </div>

        <div v-else-if="!isLoggedIn" class="flex-1 flex flex-col overflow-y-auto bg-gray-50 dark:bg-gray-900">
            <div class="mt-20 flex flex-col items-center justify-center space-y-4 px-6">
                <i class="fa-solid fa-moon text-blue-500 text-7xl drop-shadow-lg"></i>
                <h1 class="text-3xl font-black text-gray-900 dark:text-white">Night Shift Pro</h1>
                <div class="bg-gray-200 dark:bg-gray-800 px-4 py-1 rounded-full text-sm font-bold text-gray-600 dark:text-gray-300">{{ isStaffLoginMode ? 'åº—èˆ—ç®¡ç†è€…' : 'ã‚­ãƒ£ã‚¹ãƒˆ' }}ãƒ­ã‚°ã‚¤ãƒ³</div>
            </div>
            <div class="px-8 mt-6 space-y-6">
                <form v-if="isStaffLoginMode" @submit.prevent="loginStaff" class="space-y-4">
                    <input v-model="staffIdInput" type="text" autocomplete="username" placeholder="ç®¡ç†è€…ID" class="w-full p-4 rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800">
                    <input v-model="staffPassInput" type="password" autocomplete="current-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="w-full p-4 rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg">ç®¡ç†ç”»é¢ã¸</button>
                </form>
                <form v-else @submit.prevent="loginCast" class="space-y-4">
                    <input v-model="storeIdInput" type="text" autocomplete="on" placeholder="åº—èˆ—ID" class="w-full p-4 rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 uppercase">
                    <input v-model="castCodeInput" type="text" autocomplete="on" placeholder="ã‚­ãƒ£ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰" class="w-full p-4 rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-800 uppercase">
                    <button type="submit" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </form>
                <div class="text-center mt-4"><button type="button" @click="isStaffLoginMode=!isStaffLoginMode" class="text-sm text-gray-500 underline">{{ isStaffLoginMode ? 'ã‚­ãƒ£ã‚¹ãƒˆã®æ–¹' : 'åº—èˆ—ç®¡ç†è€…ã®æ–¹' }}</button></div>
                <div class="text-center mt-8"><button type="button" @click="showRegisterModal=true" class="text-xs text-blue-500 font-bold">åº—èˆ—ã‚’æ–°è¦ä½œæˆã™ã‚‹</button></div>
            </div>
        </div>

        <div v-else-if="isSuperAdmin" class="flex-1 flex flex-col h-full bg-gray-900 text-white">
            <header class="bg-gray-800 border-b border-gray-700 px-4 py-4 pt-12 shadow-sm flex justify-between items-center sticky top-0 z-10">
                <h2 class="font-bold text-lg text-yellow-400"><i class="fa-solid fa-lock mr-2"></i>Super Admin</h2>
                <button @click="logout" class="text-xs bg-red-600 px-3 py-1 rounded">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </header>
            <main class="flex-1 overflow-y-auto p-4">
                <h3 class="font-bold mb-4 text-gray-400">ç™»éŒ²åº—èˆ—ä¸€è¦§ ({{ allStoresList.length }})</h3>
                <div v-if="allStoresList.length === 0" class="text-center text-gray-500 mt-10">åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãªã—</div>
                <div v-for="store in allStoresList" :key="store.id" class="bg-gray-800 p-4 rounded-xl mb-4 border border-gray-700">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-lg text-white">{{ store.storeName }}</div>
                            <div class="text-xs text-gray-400 font-mono">ID: {{ store.storeDisplayId }}</div>
                        </div>
                        <button @click="deleteStoreForce(store.id, store.storeName)" class="bg-red-900/50 text-red-400 border border-red-800 px-3 py-1 rounded text-xs hover:bg-red-900">
                            <i class="fa-solid fa-trash mr-1"></i>å‰Šé™¤
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 space-y-1 bg-gray-900/50 p-2 rounded">
                        <div>ğŸ“§ {{ store.storeEmail }}</div>
                        <div>ğŸ‘¤ StaffID: {{ store.staffLoginId }} / Pass: {{ store.staffPassword }}</div>
                        <div>ğŸ‘¥ ã‚­ãƒ£ã‚¹ãƒˆæ•°: {{ store.casts ? store.casts.length : 0 }}å</div>
                    </div>
                </div>
            </main>
        </div>

        <div v-else class="flex-1 flex flex-col h-full relative bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">
            <header class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border-b dark:border-gray-700 px-4 py-3 pt-12 shadow-sm flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center space-x-2">
                    <button v-if="viewingChatId" @click="closeChat" class="text-blue-500 mr-1"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 class="font-bold text-lg truncate max-w-[200px]">{{ pageTitle }}</h2>
                </div>
                <div v-if="activeCast" class="text-xs font-mono bg-pink-100 dark:bg-pink-900 text-pink-800 dark:text-pink-100 px-2 py-1 rounded">{{ activeCast.name }}</div>
                <div v-if="!activeCast" class="text-xs font-mono bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100 px-2 py-1 rounded">åº—èˆ—ç®¡ç†è€…</div>
            </header>

            <main class="flex-1 overflow-y-auto pb-24 px-4 py-4" ref="mainScroll">
                
                <div v-if="currentTab==='staff-home' && !viewingChatId">
                    <div v-if="absenceShifts.length > 0" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-xl shadow-sm mb-6 animate-pulse">
                        <h3 class="font-bold text-red-600 dark:text-red-400 mb-2"><i class="fa-solid fa-triangle-exclamation"></i> æ¬ å‹¤ãƒ»é…åˆ»ã®é€£çµ¡</h3>
                        <div v-for="shift in absenceShifts" :key="shift.id" class="bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm mb-2 border-l-4 border-red-500">
                            <div class="flex justify-between font-bold"><span>{{ shift.castName }}</span><span class="text-red-500">æ¬ å‹¤</span></div>
                            <div class="text-xs text-gray-500 mt-1">{{ formatDateTime(shift.date) }}</div>
                            <div class="flex gap-2 mt-2"><button @click="updateShift(shift,'æ‰¿èªæ¸ˆã¿')" class="flex-1 bg-red-500 text-white py-2 rounded text-xs font-bold">ç¢ºèª (æ‰¿èª)</button></div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-4">
                        <h3 class="font-bold text-gray-500 dark:text-gray-400 mb-2"><i class="fa-solid fa-calendar-check mr-2"></i>æœ¬æ—¥ã®å‡ºå‹¤ ({{ todayShifts.length }}å)</h3>
                        <div v-if="todayShifts.length===0" class="text-xs text-gray-400 text-center py-2">å‡ºå‹¤äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>
                        <div class="flex flex-col gap-2">
                            <div v-for="s in todayShifts" :key="s.id" class="flex items-center gap-3 bg-blue-50 dark:bg-gray-700 p-2 rounded-lg relative overflow-hidden">
                                <div v-if="s.attendanceConfirmed" class="absolute right-0 top-0 bg-green-500 text-white text-[10px] px-2 py-0.5 rounded-bl font-bold">å‡ºå‹¤OK</div>
                                <img v-if="getCastIcon(s.castId)" :src="getCastIcon(s.castId)" class="w-8 h-8 rounded-full profile-img bg-white">
                                <div v-else class="w-8 h-8 bg-blue-200 rounded-full flex center items-center justify-center text-blue-500 text-xs"><i class="fa-solid fa-user"></i></div>
                                <div class="flex-1 font-bold text-sm flex items-center gap-2">{{ s.castName }}<i v-if="s.attendanceConfirmed" class="fa-solid fa-circle-check text-green-500"></i></div>
                                <div class="text-xs font-mono bg-white dark:bg-gray-600 px-2 py-1 rounded">{{ s.startTime }}-{{ s.endTime }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6 text-right">
                        <button @click="showAnnouncementModal=true" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-full font-bold text-sm shadow-sm"><i class="fa-solid fa-bullhorn mr-2"></i>ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿ã™ã‚‹</button>
                    </div>

                    <div class="text-sm text-gray-500 font-bold mb-2">æ‰¿èªå¾…ã¡ã‚·ãƒ•ãƒˆ</div>
                    <div v-if="pendingShifts.length===0" class="text-center py-6 text-gray-400 text-sm">ãªã—</div>
                    <div v-for="shift in pendingShifts" :key="shift.id" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-3 border-l-4 border-blue-500">
                        <div class="flex justify-between font-bold mb-1"><span>{{ shift.castName }}</span><span>{{ formatDate(shift.date) }}</span></div>
                        <div class="text-xs mb-2 bg-blue-50 text-blue-600 px-2 py-1 rounded inline-block">{{ shift.type }} {{ shift.startTime }}-{{ shift.endTime }}</div>
                        <div v-if="shift.note" class="text-xs text-gray-500 bg-gray-50 p-2 rounded mb-2">{{ shift.note }}</div>
                        <div class="flex gap-2"><button @click="updateShift(shift,'å´ä¸‹')" class="flex-1 bg-gray-100 text-red-500 py-2 rounded text-xs font-bold">å´ä¸‹</button><button @click="updateShift(shift,'æ‰¿èªæ¸ˆã¿')" class="flex-1 bg-blue-600 text-white py-2 rounded text-xs font-bold">æ‰¿èª</button></div>
                    </div>
                </div>

                <div v-if="currentTab==='cast-home' && !viewingChatId">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-500 dark:text-gray-400">æœ€æ–°ã®ãŠçŸ¥ã‚‰ã›</h3>
                            <button @click="currentTab='news'" class="text-xs text-blue-500">ã™ã¹ã¦è¦‹ã‚‹</button>
                        </div>
                        <div v-if="sortedAnnouncements.length===0" class="text-xs text-gray-400 text-center">ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                        <div v-for="(news, i) in sortedAnnouncements.slice(0,3)" :key="i" @click="openNews(news)" class="news-item cursor-pointer text-sm border-b dark:border-gray-700 pb-2 mb-2 last:border-0 last:mb-0">
                            <div class="flex justify-between text-xs text-gray-400">
                                <span>{{ formatDateTime(news.date) }}</span>
                                <span v-if="!news.readBy?.includes(activeCast.id)" class="bg-red-100 text-red-500 px-1 rounded text-[10px] font-bold">æœªèª­</span>
                            </div>
                            <div class="mt-1 font-medium truncate">{{ news.text }}</div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-6">
                        <h3 class="font-bold text-gray-500 dark:text-gray-400 mb-4"><i class="fa-solid fa-calendar-week mr-2"></i>ä»Šé€±ã®ã‚·ãƒ•ãƒˆ</h3>
                        <div class="space-y-3">
                            <div v-for="day in next7Days" :key="day.dateStr" class="flex justify-between items-center py-2 border-b dark:border-gray-700 last:border-0">
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold" :class="{'text-blue-600': isSameDay(day.dateStr, todayStr)}">
                                        {{ new Date(day.dateStr).getDate() }}æ—¥ ({{ ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(day.dateStr).getDay()] }})
                                        <span v-if="isSameDay(day.dateStr, todayStr)" class="text-[10px] bg-blue-100 text-blue-600 px-1 rounded ml-1">ä»Šæ—¥</span>
                                    </span>
                                </div>
                                <div>
                                    <template v-if="getMyShift(day.dateStr)">
                                        <div class="text-right">
                                            <div class="text-sm font-bold" :class="getMyShift(day.dateStr).status==='æ‰¿èªæ¸ˆã¿' ? 'text-gray-800 dark:text-gray-100' : 'text-gray-400'">
                                                {{ getMyShift(day.dateStr).startTime }} - {{ getMyShift(day.dateStr).endTime }}
                                            </div>
                                            <div class="text-[10px]" :class="getMyShift(day.dateStr).status==='æ‰¿èªæ¸ˆã¿' ? 'text-blue-500' : 'text-gray-400'">
                                                {{ getMyShift(day.dateStr).status }}
                                            </div>
                                        </div>
                                    </template>
                                    <template v-else>
                                        <span class="text-xs text-gray-300">ãƒ¼</span>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button @click="currentTab='cast-calendar'" class="text-sm text-blue-500 font-bold border border-blue-200 bg-blue-50 px-4 py-2 rounded-full">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è¦‹ã‚‹</button>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab==='news' && !viewingChatId">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
                        <h3 class="font-bold mb-4 text-lg">ãŠçŸ¥ã‚‰ã›ä¸€è¦§</h3>
                        <div v-if="sortedAnnouncements.length===0" class="text-gray-400 text-center py-10">ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                        <div v-for="(news, i) in sortedAnnouncements" :key="i" @click="openNews(news)" class="news-item cursor-pointer border-b dark:border-gray-700 py-4 last:border-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs text-gray-400">{{ formatDateTime(news.date) }}</span>
                                <div v-if="activeCast">
                                    <span v-if="news.readBy?.includes(activeCast.id)" class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full font-bold">âœ… ç¢ºèªæ¸ˆ</span>
                                    <span v-else class="text-[10px] bg-red-100 text-red-500 px-2 py-0.5 rounded-full font-bold">æœªèª­</span>
                                </div>
                                <button v-if="!activeCast" @click.stop="deleteAnnouncement(news)" class="text-red-400 text-xs"><i class="fa-solid fa-trash"></i> å‰Šé™¤</button>
                            </div>
                            <div class="font-bold text-sm whitespace-pre-wrap">{{ news.text }}</div>
                        </div>
                    </div>
                </div>

                <div v-if="(currentTab==='staff-calendar' || currentTab==='cast-calendar') && !viewingChatId">
                    <div v-if="activeCast" class="mb-4 space-y-2">
                        <div v-if="todaysMyShift && !todaysMyShift.attendanceConfirmed" class="bg-blue-50 border border-blue-200 p-3 rounded-xl flex items-center justify-between">
                            <div class="text-sm text-blue-800 font-bold">æœ¬æ—¥ã‚·ãƒ•ãƒˆ: {{todaysMyShift.startTime}}-{{todaysMyShift.endTime}}</div>
                            <button @click="confirmAttendance(todaysMyShift)" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow">å‡ºå‹¤ç¢ºèª</button>
                        </div>
                        <div v-if="todaysMyShift && todaysMyShift.attendanceConfirmed" class="bg-green-50 border border-green-200 p-2 rounded-xl text-center text-green-700 text-xs font-bold"><i class="fa-solid fa-check"></i> å‡ºå‹¤ç¢ºèªæ¸ˆã¿</div>
                        <button @click="reportAbsence" class="w-full p-3 bg-red-50 text-red-600 font-bold rounded-xl border border-red-200 shadow-sm"><i class="fa-solid fa-triangle-exclamation"></i> å½“æ—¥æ¬ å‹¤ãƒ»é…åˆ»é€£çµ¡</button>
                    </div>

                    <div v-if="activeCast && activeCast.settings?.showSalary" class="bg-gradient-to-r from-pink-500 to-rose-500 rounded-xl p-4 text-white shadow-lg mb-4">
                        <div class="flex justify-between items-end mb-1"><div class="text-xs opacity-90">ç¢ºå®šçµ¦ä¸</div><div class="text-xl font-bold">Â¥{{ salaryInfo.confirmed.toLocaleString() }}</div></div>
                        <div class="flex justify-between items-end border-t border-white/30 pt-1"><div class="text-xs opacity-80">ï¼‹æ‰¿èªå¾…ã¡(è¦‹è¾¼ã¿)</div><div class="text-sm font-bold opacity-90">Â¥{{ salaryInfo.pending.toLocaleString() }}</div></div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-4 mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <button @click="changeMonth(-1)" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700"><i class="fa-solid fa-chevron-left"></i></button>
                            <div class="text-center"><h3 class="font-bold text-lg">{{ currentMonthDisplay }}</h3><button @click="goToToday" class="text-xs text-blue-500 font-bold bg-blue-50 px-2 py-0.5 rounded mt-1">ä»Šæ—¥ã«æˆ»ã‚‹</button></div>
                            <button @click="changeMonth(1)" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs text-gray-400"><span v-for="w in ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ']" :key="w">{{w}}</span></div>
                        <div class="grid grid-cols-7 gap-2">
                            <div v-for="day in calendarDays" :key="day.dateStr" @click="selectDate(day.dateStr)" class="aspect-square flex flex-col items-center justify-center rounded-lg border relative cursor-pointer" :class="isSameDay(day.dateStr, selectedDate) ? 'border-pink-500 bg-pink-50 dark:bg-pink-900/30' : (day.isCurrentMonth ? 'border-transparent bg-gray-50 dark:bg-gray-700' : 'border-transparent bg-gray-100/50 dark:bg-gray-800/50 text-gray-400')">
                                <span class="text-sm" :class="{'font-bold text-blue-600': isSameDay(day.dateStr, todayStr)}">{{ day.dateStr ? new Date(day.dateStr).getDate() : '' }}</span>
                                <div class="h-1 mt-1 flex gap-0.5"><div v-if="activeCast && getMyShift(day.dateStr)" class="w-1.5 h-1.5 rounded-full" :class="getShiftColor(getMyShift(day.dateStr))"></div></div>
                                <div v-if="!activeCast && getStaffCount(day.dateStr)>0" class="absolute bottom-0 right-0 text-[8px] bg-blue-100 text-blue-600 px-1 rounded-tl">{{ getStaffCount(day.dateStr) }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 min-h-[200px]">
                        <h4 class="font-bold text-lg mb-4 border-b pb-2 flex justify-between">
                            <span>{{ formatDate(selectedDate) }}</span>
                            <span v-if="activeCast && getMyShift(selectedDate)" class="text-sm px-2 py-1 rounded" :class="getShiftColor(getMyShift(selectedDate)) + ' text-white'">{{ getMyShift(selectedDate).status }}</span>
                        </h4>

                        <div v-if="!activeCast">
                            <div v-if="getDailyShifts(selectedDate).length===0" class="text-gray-400 text-center py-4">å‡ºå‹¤äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>
                            <div v-for="s in getDailyShifts(selectedDate)" :key="s.id" class="flex items-center gap-3 py-3 border-b dark:border-gray-700 last:border-0">
                                <img v-if="getCastIcon(s.castId)" :src="getCastIcon(s.castId)" class="w-10 h-10 rounded-full profile-img bg-gray-200">
                                <div v-else class="w-10 h-10 bg-gray-200 rounded-full flex center items-center justify-center text-gray-400"><i class="fa-solid fa-user"></i></div>
                                <div class="flex-1">
                                    <div class="font-bold flex items-center gap-2">{{ s.castName }}<i v-if="s.attendanceConfirmed" class="fa-solid fa-circle-check text-green-500 text-sm"></i></div>
                                    <div class="text-xs text-gray-400">å®Ÿç¸¾: {{ Object.keys(s.backs||{}).length }}ä»¶</div>
                                </div>
                                <button @click="remindAttendance(s.castId)" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded border border-blue-200 hover:bg-blue-200"><i class="fa-regular fa-paper-plane"></i> é€£çµ¡</button>
                                <div class="text-sm bg-blue-50 text-blue-600 px-2 py-1 rounded font-mono">{{ s.startTime }} - {{ s.endTime }}</div>
                            </div>
                        </div>

                        <div v-else>
                            <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg mb-6"><button v-for="t in ['å‡ºå‹¤','ä¼‘ã¿','è¦ç›¸è«‡']" @click="editingShift.type=t" class="flex-1 py-2 text-sm rounded-md font-bold" :class="editingShift.type===t?'bg-white shadow text-black':'text-gray-400'">{{ t }}</button></div>
                            <div v-if="editingShift.type==='å‡ºå‹¤'">
                                <div class="flex gap-2 mb-4"><input v-model="editingShift.startTime" type="time" class="flex-1 p-2 border rounded dark:bg-gray-700"><input v-model="editingShift.endTime" type="time" class="flex-1 p-2 border rounded dark:bg-gray-700"></div>
                                <div v-if="storeData.backOptions?.length > 0" class="mb-4 space-y-2"><div v-for="opt in storeData.backOptions" :key="opt.id" class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded"><span class="text-xs">{{ opt.name }}</span><input type="number" v-model="editingShift.backs[opt.id]" placeholder="0" class="w-16 p-1 text-right rounded border dark:border-gray-600 bg-white dark:bg-gray-800 text-sm"></div></div>
                            </div>
                            <input v-model="editingShift.note" placeholder="å‚™è€ƒ" class="w-full p-3 border rounded mb-4 dark:bg-gray-700">
                            <button @click="submitShift" class="w-full bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg mb-6">ä¿å­˜</button>

                            <div class="border-t dark:border-gray-700 pt-4">
                                <h5 class="font-bold text-sm text-gray-500 mb-2">ä»Šæœˆã®ã‚·ãƒ•ãƒˆä¸€è¦§</h5>
                                <div v-for="s in getMyMonthlyShifts" :key="s.id" class="flex justify-between items-center py-2 border-b dark:border-gray-800 text-sm">
                                    <span>{{ new Date(s.date).getDate() }}æ—¥({{ ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(s.date).getDay()] }})</span>
                                    <span v-if="s.status==='æ‰¿èªæ¸ˆã¿'" class="text-blue-600 font-bold">ç¢ºå®š ({{s.startTime}}-{{s.endTime}})</span>
                                    <span v-else class="text-gray-400">æå‡ºæ¸ˆã¿ (æ‰¿èªå¾…ã¡)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab==='staff-casts'">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-500">ã‚­ãƒ£ã‚¹ãƒˆ</h3><div class="flex gap-2"><button @click="showBackSettings=true" class="text-xs bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded font-bold">ãƒãƒƒã‚¯è¨­å®š</button><button @click="addCast" class="text-blue-600 font-bold text-sm">è¿½åŠ </button></div></div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden"><div v-for="(cast, i) in storeData.casts" :key="cast.id" class="p-4 border-b dark:border-gray-700 flex justify-between items-center"><div class="flex items-center gap-3"><img v-if="cast.icon" :src="cast.icon" class="w-10 h-10 rounded-full profile-img bg-gray-200"><div v-else class="w-10 h-10 bg-gray-200 rounded-full flex center items-center justify-center"><i class="fa-solid fa-user text-gray-400"></i></div><div><div class="font-bold">{{ cast.name }}</div><div class="text-xs text-gray-400 font-mono">{{ cast.code }}</div></div></div><div class="flex gap-3"><button @click="showQRCode(cast)" class="text-blue-400"><i class="fa-solid fa-qrcode"></i></button><button @click="deleteCast(cast)" class="text-red-400"><i class="fa-solid fa-trash"></i></button></div></div></div>
                </div>

                <div v-if="currentTab==='messages' && !viewingChatId && !activeCast">
                    <div v-for="c in storeData.casts" :key="c.id" @click="openChat(c.id, c.name)" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm flex items-center gap-3 mb-2 cursor-pointer"><img v-if="c.icon" :src="c.icon" class="w-12 h-12 rounded-full profile-img bg-gray-200"><div v-else class="w-12 h-12 bg-pink-100 rounded-full flex center justify-center items-center"><i class="fa-solid fa-user text-pink-500"></i></div><div class="flex-1"><div class="font-bold">{{ c.name }}</div><div class="text-xs text-gray-500 truncate">{{ getLastMsg(c.id) }}</div></div><div v-if="getUnreadCount(c.id)>0" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">{{ getUnreadCount(c.id) }}</div></div>
                </div>
                <div v-if="viewingChatId || (activeCast && currentTab==='messages')" class="flex flex-col gap-4 pb-4"><div v-if="currentMessages.length===0" class="text-center text-gray-400 text-sm mt-10">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—</div><div v-for="m in currentMessages" :key="m.id" class="flex flex-col" :class="isMyMessage(m)?'items-end':'items-start'"><div class="msg-bubble px-4 py-2 rounded-2xl text-sm" :class="isMyMessage(m)?(activeCast?'bg-pink-500 text-white':'bg-blue-500 text-white'):'bg-white dark:bg-gray-800 shadow-sm'">{{ m.text }}</div><span class="text-[10px] text-gray-400 mt-1 flex gap-1"><span v-if="isMyMessage(m) && m.isRead" class="text-blue-400">æ—¢èª­</span>{{ formatTime(m.timestamp) }}</span></div></div>

                <div v-if="currentTab==='settings'">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm mb-6 p-4"><div class="flex items-center gap-4 mb-4"><div class="relative w-16 h-16"><img v-if="activeCast?.icon || storeData.icon" :src="activeCast ? activeCast.icon : storeData.icon" class="w-16 h-16 rounded-full profile-img bg-gray-200"><div v-else class="w-16 h-16 bg-gray-200 rounded-full flex center items-center justify-center text-2xl"><i class="fa-solid fa-user text-gray-400"></i></div><label class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs cursor-pointer shadow"><i class="fa-solid fa-camera"></i><input type="file" class="hidden" accept="image/*" @change="uploadIcon"></label></div><div><div class="font-bold text-lg">{{ activeCast ? activeCast.name : storeData.storeName }}</div><div class="text-xs text-gray-400 font-mono select-all">ID: {{ activeCast ? activeCast.code : storeData.storeDisplayId }}</div></div></div><div v-if="!activeCast" class="mb-4"><label class="text-xs font-bold text-gray-500">é€šçŸ¥ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input v-model="storeData.storeEmail" @change="updateStore({storeEmail:storeData.storeEmail})" placeholder="æ¬ å‹¤é€£çµ¡ã‚’å—ã‘å–ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹" class="w-full p-2 border rounded dark:bg-gray-700 text-sm mt-1"></div><div v-if="activeCast" class="p-4 border-t dark:border-gray-700 space-y-4"><div class="flex justify-between items-center"><span class="text-sm font-bold">çµ¦ä¸æ¦‚ç®—ã‚’è¡¨ç¤º</span><button @click="toggleSalaryDisplay" class="w-10 h-5 bg-gray-300 rounded-full relative" :class="{'bg-green-500':activeCast.settings?.showSalary}"><div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-all" :class="{'left-6':activeCast.settings?.showSalary}"></div></button></div><div v-if="activeCast.settings?.showSalary"><label class="text-xs text-gray-500">åŸºæœ¬æ™‚çµ¦</label><div class="flex items-center gap-2"><input type="number" v-model="activeCast.settings.hourlyRate" @change="saveCastSettings" class="p-2 border rounded w-24 bg-gray-50 dark:bg-gray-700 text-right"><span class="text-sm">å††</span></div></div></div><div class="border-t dark:border-gray-700 pt-2 mt-2"><button @click="showHelpModal='usage'" class="w-full text-left py-3 text-sm flex justify-between items-center"><span>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</span><i class="fa-solid fa-chevron-right text-xs text-gray-400"></i></button><button @click="showHelpModal='terms'" class="w-full text-left py-3 text-sm flex justify-between items-center"><span>åˆ©ç”¨è¦ç´„</span><i class="fa-solid fa-chevron-right text-xs text-gray-400"></i></button><button @click="openFeedback" class="w-full text-left py-3 text-sm flex justify-between items-center"><span>ä¸å…·åˆå ±å‘Šãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span><i class="fa-solid fa-envelope text-xs text-gray-400"></i></button></div><button @click="logout" class="w-full text-left py-2 text-red-500 font-bold border-t dark:border-gray-700 pt-4 mt-2">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>
                </div>
            </main>

            <div v-if="viewingChatId || (activeCast && currentTab==='messages')" class="bg-white dark:bg-gray-800 p-3 border-t dark:border-gray-700 safe-area-bottom flex gap-2"><input v-model="chatInput" placeholder="å…¥åŠ›..." class="flex-1 bg-gray-100 dark:bg-gray-700 p-3 rounded-full dark:text-white"><button @click="sendMessage" :disabled="!chatInput" class="text-blue-500"><i class="fa-solid fa-paper-plane text-xl"></i></button></div>
            <nav v-if="!viewingChatId" class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 safe-area-bottom px-4 py-2 flex justify-between text-xs text-gray-400 z-20">
                <template v-if="!activeCast && !isSuperAdmin">
                    <button @click="currentTab='staff-home'" :class="{'text-blue-600':currentTab==='staff-home'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-house text-xl"></i><span class="text-[9px]">ãƒ›ãƒ¼ãƒ </span></button>
                    <button @click="currentTab='staff-calendar'; goToToday()" :class="{'text-blue-600':currentTab==='staff-calendar'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-calendar-days text-xl"></i><span class="text-[9px]">ã‚·ãƒ•ãƒˆ</span></button>
                    <button @click="currentTab='messages'" :class="{'text-blue-600':currentTab==='messages'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-message text-xl"></i><span class="text-[9px]">ãƒˆãƒ¼ã‚¯</span></button>
                    <button @click="currentTab='news'" :class="{'text-blue-600':currentTab==='news'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-bullhorn text-xl"></i><span class="text-[9px]">ãŠçŸ¥ã‚‰ã›</span></button>
                    <button @click="currentTab='staff-casts'" :class="{'text-blue-600':currentTab==='staff-casts'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-users text-xl"></i><span class="text-[9px]">ã‚­ãƒ£ã‚¹ãƒˆ</span></button>
                    <button @click="currentTab='settings'" :class="{'text-blue-600':currentTab==='settings'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-gear text-xl"></i><span class="text-[9px]">è¨­å®š</span></button>
                </template>
                <template v-if="activeCast">
                    <button @click="currentTab='cast-home'" :class="{'text-pink-500':currentTab==='cast-home'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-house text-xl"></i><span class="text-[9px]">ãƒ›ãƒ¼ãƒ </span></button>
                    <button @click="markChatRead(); currentTab='cast-calendar'; goToToday()" :class="{'text-pink-500':currentTab==='cast-calendar'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-calendar-days text-xl"></i><span class="text-[9px]">ã‚·ãƒ•ãƒˆ</span></button>
                    <button @click="markChatRead(); currentTab='messages'" :class="{'text-pink-500':currentTab==='messages'}" class="flex flex-col items-center w-12 gap-1 relative"><i class="fa-solid fa-message text-xl"></i><span class="text-[9px]">ãƒˆãƒ¼ã‚¯</span><span v-if="totalUnread>0" class="absolute top-0 right-2 w-2 h-2 bg-red-500 rounded-full"></span></button>
                    <button @click="markChatRead(); currentTab='news'" :class="{'text-pink-500':currentTab==='news'}" class="flex flex-col items-center w-12 gap-1 relative"><i class="fa-solid fa-bullhorn text-xl"></i><span class="text-[9px]">ãŠçŸ¥ã‚‰ã›</span></button>
                    <button @click="markChatRead(); currentTab='settings'" :class="{'text-pink-500':currentTab==='settings'}" class="flex flex-col items-center w-12 gap-1"><i class="fa-solid fa-gear text-xl"></i><span class="text-[9px]">è¨­å®š</span></button>
                </template>
            </nav>
        </div>

        <div v-if="showAnnouncementModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl"><h3 class="font-bold mb-4">ãŠçŸ¥ã‚‰ã›æŠ•ç¨¿</h3><textarea v-model="newAnnouncementText" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg h-32 mb-4"></textarea><div class="flex gap-3"><button @click="showAnnouncementModal=false" class="flex-1 py-3 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button @click="postAnnouncement" class="flex-1 bg-blue-600 text-white rounded-lg font-bold">æŠ•ç¨¿</button></div></div></div>
        <div v-if="showRegisterModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl"><h3 class="font-bold mb-4">æ–°è¦åº—èˆ—ç™»éŒ²</h3><input v-model="newStoreName" placeholder="åº—èˆ—å" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg mb-4"><input v-model="newStoreEmail" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg mb-4"><div class="flex gap-3"><button @click="showRegisterModal=false" class="flex-1 py-3 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button @click="registerStore" class="flex-1 bg-blue-600 text-white rounded-lg font-bold">ä½œæˆ</button></div></div></div>
        <div v-if="showBackSettings" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl h-[70vh] flex flex-col"><h3 class="font-bold mb-4">ãƒãƒƒã‚¯è¨­å®š</h3><div class="flex-1 overflow-y-auto space-y-2 mb-4"><div v-for="(opt, i) in storeData.backOptions" :key="i" class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded"><span>{{ opt.name }} (Â¥{{ opt.price }})</span><button @click="deleteBackOption(opt)" class="text-red-400"><i class="fa-solid fa-trash"></i></button></div></div><div class="border-t pt-4 space-y-2"><input v-model="newBackName" placeholder="é …ç›®å" class="w-full p-2 border rounded dark:bg-gray-700"><input v-model="newBackPrice" type="number" placeholder="å˜ä¾¡" class="w-full p-2 border rounded dark:bg-gray-700"><button @click="addBackOption" class="w-full bg-blue-600 text-white py-2 rounded font-bold">è¿½åŠ </button><button @click="showBackSettings=false" class="w-full text-gray-500 mt-2">é–‰ã˜ã‚‹</button></div></div></div>
        <div v-if="selectedNews" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl"><div class="text-xs text-gray-400 mb-2">{{ formatDateTime(selectedNews.date) }}</div><div class="whitespace-pre-wrap font-medium mb-6 dark:text-gray-100 max-h-[50vh] overflow-y-auto">{{ selectedNews.text }}</div><div v-if="activeCast"><button v-if="!selectedNews.readBy?.includes(activeCast.id)" @click="confirmNews" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">ç¢ºèªã—ã¾ã—ãŸ</button><button v-else class="w-full bg-gray-200 dark:bg-gray-700 text-gray-500 font-bold py-3 rounded-xl" disabled>ç¢ºèªæ¸ˆã¿</button></div><button @click="selectedNews=null" class="mt-3 w-full text-gray-500 py-2">é–‰ã˜ã‚‹</button></div></div>
        <div v-if="showQRModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl text-center"><h3 class="font-bold mb-2">{{ qrTargetName }}</h3><p class="text-xs text-gray-400 mb-4">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³</p><div class="flex justify-center mb-4"><img :src="`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrUrl)}`" alt="QR Code" class="border rounded p-2 bg-white"></div><button @click="showQRModal=false" class="py-2 px-6 bg-blue-600 text-white rounded-lg">é–‰ã˜ã‚‹</button></div></div>
        <div v-if="showHelpModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl h-[70vh] flex flex-col"><h3 class="font-bold mb-4">{{ showHelpModal==='terms'?'åˆ©ç”¨è¦ç´„':'ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰' }}</h3><div class="flex-1 overflow-y-auto text-sm space-y-3 text-gray-600 dark:text-gray-300"><template v-if="showHelpModal==='terms'"><p>1. æœ¬ã‚¢ãƒ—ãƒªã¯ãƒ™ãƒ¼ã‚¿ç‰ˆã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®æ¶ˆå¤±ç­‰ã«ã¤ã„ã¦è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</p><p>2. å…¥åŠ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯Firebase(Google)ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p><p>3. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã¯é©åˆ‡ã«ç®¡ç†ã—ã¦ãã ã•ã„ã€‚</p></template><template v-else><p><strong>ã€åº—èˆ—ç®¡ç†è€…ã€‘</strong><br>ãƒ»ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ID/QRã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚<br>ãƒ»ã‚·ãƒ•ãƒˆã®æ‰¿èª/å´ä¸‹ãŒã§ãã¾ã™ã€‚</p><p><strong>ã€ã‚­ãƒ£ã‚¹ãƒˆã€‘</strong><br>ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰å¸Œæœ›ã‚·ãƒ•ãƒˆã‚’æå‡ºã—ã¾ã™ã€‚<br>ãƒ»ã€Œè¨­å®šã€ã§æ™‚çµ¦ã‚’ç™»éŒ²ã™ã‚‹ã¨çµ¦ä¸ç›®å®‰ãŒå‡ºã¾ã™ã€‚</p></template></div><button @click="showHelpModal=null" class="mt-4 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg">é–‰ã˜ã‚‹</button></div></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, arrayUnion, arrayRemove, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyD932E1eO3VTLQR49mibJFm-jks2xtVf0c", authDomain: "night-shift-pro.firebaseapp.com", projectId: "night-shift-pro", storageBucket: "night-shift-pro.firebasestorage.app", messagingSenderId: "98250749733", appId: "1:98250749733:web:167c5f6cc6a2e901160ccc", measurementId: "G-7CFY2WW6TG" };
        
        const emailConfig = { 
            publicKey: "pBXsfa-38OMNK1E6b", 
            serviceId: "service_71f25g6", 
            templateId: "template_675u7wq", 
            notificationTemplateId: "template_36z9afr" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        if(window.emailjs) emailjs.init(emailConfig.publicKey);

        const { createApp, ref, computed, reactive, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                const isLoading = ref(true);
                const storeData = ref({ casts:[], shifts:[], messages:[], announcements:[], backOptions:[] });
                const isLoggedIn = ref(false);
                const isStaffLoginMode = ref(false);
                const isSuperAdmin = ref(false); // â˜… ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ãƒ•ãƒ©ã‚°
                const allStoresList = ref([]);   // â˜… å…¨åº—èˆ—ãƒªã‚¹ãƒˆç”¨
                const currentTab = ref('staff-home');
                const viewingChatId = ref(null);
                const staffIdInput=ref(''); const staffPassInput=ref('');
                const storeIdInput=ref(''); const castCodeInput=ref('');
                const newStoreName=ref(''); const newStoreEmail=ref('');
                const chatInput=ref(''); const mainScroll=ref(null);
                const currentStoreDocId = ref(null);
                const currentCastId = ref(null);
                const currentMonth = ref(new Date());
                const selectedDate = ref(new Date().toISOString().split('T')[0]); 
                const editingShift = reactive({type:'å‡ºå‹¤',startTime:'20:00',endTime:'25:00',note:'', backs:{}});
                const showAnnouncementModal=ref(false); const newAnnouncementText=ref('');
                const showRegisterModal=ref(false); const showBackSettings=ref(false);
                const newBackName=ref(''); const newBackPrice=ref('');
                const showQRModal=ref(false); const qrUrl=ref(''); const qrTargetName=ref('');
                const showHelpModal=ref(null); const isFirstRun = ref(false);
                const selectedNews = ref(null);

                const formatLocal = (d) => {
                    const year = d.getFullYear();
                    const month = ('0' + (d.getMonth() + 1)).slice(-2);
                    const day = ('0' + d.getDate()).slice(-2);
                    return `${year}-${month}-${day}`;
                };
                
                onMounted(() => {
                    selectedDate.value = formatLocal(new Date());
                });

                const scrollToBottom = () => {
                    nextTick(() => {
                        if(mainScroll.value) mainScroll.value.scrollTop = mainScroll.value.scrollHeight;
                    });
                };

                const generateRandomId = (prefix, length) => { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return prefix + result; };
                const generateRandomPass = () => Math.random().toString(36).slice(-8);

                let unsubscribe = null;
                const subscribeToStore = (docId) => {
                    if(unsubscribe) unsubscribe();
                    unsubscribe = onSnapshot(doc(db, "stores", docId), (d) => {
                        if(d.exists()) {
                            storeData.value = d.data();
                            if(!storeData.value.backOptions) storeData.value.backOptions = [];
                        }
                    });
                };
                const checkFirstRun = async () => { const q = query(collection(db, "stores")); const snap = await getDocs(q); isFirstRun.value = snap.empty; isLoading.value = false; };

                onMounted(async () => {
                    const params = new URLSearchParams(window.location.search);
                    const sId = params.get('store'); const cCode = params.get('code');
                    if(sId && cCode) {
                        isLoading.value = true;
                        const q = query(collection(db, "stores"), where("storeDisplayId", "==", sId));
                        const snap = await getDocs(q);
                        if(!snap.empty) {
                            const d = snap.docs[0]; const data = d.data(); const cast = data.casts.find(c => c.code === cCode);
                            if(cast) { currentStoreDocId.value = d.id; currentCastId.value = cast.id; subscribeToStore(d.id); isLoggedIn.value = true; currentTab.value = 'cast-home'; window.history.replaceState(null, '', window.location.pathname); }
                        }
                    }
                    checkFirstRun();
                });

                const updateStore = async (data) => { if(currentStoreDocId.value) await updateDoc(doc(db, "stores", currentStoreDocId.value), data); };
                const markChatRead = async () => {
                    if(!storeData.value.messages) return;
                    let needsUpdate = false;
                    const newMessages = storeData.value.messages.map(m => {
                        if(activeCast.value && !m.isSenderCast && !m.isRead && m.castId === activeCast.value.id) { needsUpdate = true; return { ...m, isRead: true }; }
                        if(!activeCast.value && viewingChatId.value && m.isSenderCast && !m.isRead && m.castId === viewingChatId.value) { needsUpdate = true; return { ...m, isRead: true }; }
                        return m;
                    });
                    if(needsUpdate) await updateStore({ messages: newMessages });
                };

                const confirmAttendance = async (s) => {
                    if(!s) return;
                    await updateShift(s, 'æ‰¿èªæ¸ˆã¿', true); 
                    alert("å‡ºå‹¤ç¢ºèªã‚’å®Œäº†ã—ã¾ã—ãŸï¼");
                };

                const openNews = (news) => { selectedNews.value = news; };
                const postAnnouncement = async () => { 
                    if(newAnnouncementText.value) { 
                        const news = { id: Date.now().toString(), text: newAnnouncementText.value, date: new Date().toISOString(), readBy: [] }; 
                        await updateStore({ announcements: arrayUnion(news) }); 
                        showAnnouncementModal.value=false; 
                        newAnnouncementText.value='';
                        alert("ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼"); 
                    } 
                };
                const deleteAnnouncement = async (news) => { await updateStore({ announcements: arrayRemove(news) }); };
                const confirmNews = async () => {
                    if(!selectedNews.value || !activeCast.value) return;
                    const oldNews = storeData.value.announcements.find(n => n.id === selectedNews.value.id);
                    if(oldNews) { const newNews = JSON.parse(JSON.stringify(oldNews)); if(!newNews.readBy) newNews.readBy = []; if(!newNews.readBy.includes(activeCast.value.id)) newNews.readBy.push(activeCast.value.id); await updateStore({ announcements: arrayRemove(oldNews) }); await updateStore({ announcements: arrayUnion(newNews) }); selectedNews.value = null; }
                };

                const registerStore = async () => {
                    if(!newStoreName.value || !newStoreEmail.value) { alert("åº—èˆ—åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
                    isLoading.value = true;
                    const id = generateRandomId('ST-', 8); const adm = generateRandomId('ADM-', 8); const pass = generateRandomPass();
                    try {
                        await addDoc(collection(db, "stores"), { storeName: newStoreName.value, storeDisplayId: id, staffLoginId: adm, staffPassword: pass, casts: [], shifts: [], messages: [], announcements: [], backOptions: [], storeEmail: newStoreEmail.value });
                        if(window.emailjs) { 
                            const params = { to_name: newStoreName.value, to_email: newStoreEmail.value, store_id: id, admin_id: adm, password: pass }; 
                            await emailjs.send(emailConfig.serviceId, emailConfig.templateId, params); 
                        }
                        alert(`ç™»éŒ²å®Œäº†ï¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\nåº—èˆ—ID: ${id}\nç®¡ç†è€…ID: ${adm}\nPass: ${pass}`);
                        newStoreName.value = ''; newStoreEmail.value = ''; showRegisterModal.value = false; checkFirstRun();
                    } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
                    isLoading.value = false;
                };

                // â˜… ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ç”¨ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
                const loginStaff = async () => { 
                    isLoading.value = true;
                    // ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…IDãƒã‚§ãƒƒã‚¯
                    if(staffIdInput.value === "ADMIN_MASTER" && staffPassInput.value === "NightShift2026") {
                        isSuperAdmin.value = true;
                        isLoggedIn.value = true;
                        await fetchAllStores();
                        isLoading.value = false;
                        return;
                    }

                    const q = query(collection(db, "stores"), where("staffLoginId", "==", staffIdInput.value), where("staffPassword", "==", staffPassInput.value)); 
                    const snap = await getDocs(q); 
                    if(!snap.empty) { 
                        const d = snap.docs[0]; 
                        currentStoreDocId.value = d.id; 
                        currentCastId.value = null; 
                        subscribeToStore(d.id); 
                        isLoggedIn.value = true; 
                        currentTab.value = 'staff-home'; 
                    } else { 
                        alert("IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); 
                    } 
                    isLoading.value = false; 
                };

                // â˜… å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—
                const fetchAllStores = async () => {
                    const q = query(collection(db, "stores"));
                    const snap = await getDocs(q);
                    allStoresList.value = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                };

                // â˜… åº—èˆ—å‰Šé™¤æ©Ÿèƒ½
                const deleteStoreForce = async (docId, name) => {
                    if(confirm(`ã€è­¦å‘Šã€‘\nåº—èˆ—ã€Œ${name}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                        try {
                            await deleteDoc(doc(db, "stores", docId));
                            alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                            await fetchAllStores(); // ãƒªã‚¹ãƒˆæ›´æ–°
                        } catch(e) {
                            alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message);
                        }
                    }
                };

                const loginCast = async () => { isLoading.value = true; const q = query(collection(db, "stores"), where("storeDisplayId", "==", storeIdInput.value.toUpperCase())); const snap = await getDocs(q); if(!snap.empty) { const d = snap.docs[0]; const data = d.data(); const cast = data.casts.find(c => c.code === castCodeInput.value.toUpperCase()); if(cast) { currentStoreDocId.value = d.id; currentCastId.value = cast.id; subscribeToStore(d.id); isLoggedIn.value = true; currentTab.value = 'cast-home'; markChatRead(); } else { alert("ã‚­ãƒ£ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); } } else { alert("åº—èˆ—IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); } isLoading.value = false; };
                const logout = () => { isLoggedIn.value=false; isSuperAdmin.value=false; currentStoreDocId.value=null; currentCastId.value=null; if(unsubscribe) unsubscribe(); };
                const addCast = async () => { const n = prompt("åå‰"); if(n) { const code = generateRandomId('C-', 6); const newCast = { id: Date.now().toString(), name: n, code: code, settings:{hourlyRate:2000, showSalary:true} }; await updateStore({ casts: arrayUnion(newCast) }); alert(`ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\nã‚³ãƒ¼ãƒ‰: ${code}`); } };
                const deleteCast = async (cast) => { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) await updateStore({ casts: arrayRemove(cast) }); };
                const addBackOption = async () => { if(newBackName.value && newBackPrice.value) { await updateStore({ backOptions: arrayUnion({ id:Date.now().toString(), name:newBackName.value, price:parseInt(newBackPrice.value) }) }); newBackName.value=''; newBackPrice.value=''; }};
                const deleteBackOption = async (opt) => { await updateStore({ backOptions: arrayRemove(opt) }); };
                const submitShift = async () => { const s = getMyShift(selectedDate.value); if(s) await updateStore({ shifts: arrayRemove(s) }); const newShift = { id: Date.now().toString(), date: selectedDate.value, castId: currentCastId.value, castName: activeCast.value.name, status: 'æ‰¿èªå¾…ã¡', ...editingShift, backs:{...editingShift.backs} }; await updateStore({ shifts: arrayUnion(newShift) }); alert("ä¿å­˜ã—ã¾ã—ãŸ"); };
                const updateShift = async (s, st, confirmed = false) => { await updateStore({ shifts: arrayRemove(s) }); const newS = {...s, status: st}; if(confirmed) newS.attendanceConfirmed = true; await updateStore({ shifts: arrayUnion(newS) }); };
                const reportAbsence = async () => { 
                    if(confirm("åº—é•·ã«æ¬ å‹¤ãƒ»é…åˆ»ã®é€£çµ¡ã‚’ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãŒé€ã‚‰ã‚Œã¾ã™ï¼‰")) { 
                        const today = formatLocal(new Date());
                        selectDate(today); 
                        editingShift.type='æ¬ å‹¤'; 
                        await submitShift(); 
                        
                        await sendMessageText('ã€è‡ªå‹•é€£çµ¡ã€‘æ¬ å‹¤ãƒ»é…åˆ»ã®é€£çµ¡ã‚’ã—ã¾ã—ãŸ', true);
                        
                        if(storeData.value.storeEmail && window.emailjs) {
                            const params = { 
                                to_email: storeData.value.storeEmail, 
                                subject: `ã€æ¬ å‹¤é€£çµ¡ã€‘${activeCast.value.name}ã•ã‚“ã‹ã‚‰é€£çµ¡ãŒã‚ã‚Šã¾ã™`, 
                                message: `${activeCast.value.name}ã•ã‚“ãŒæœ¬æ—¥ã®æ¬ å‹¤ãƒ»é…åˆ»ã‚’å ±å‘Šã—ã¾ã—ãŸã€‚\nã‚¢ãƒ—ãƒªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
                                name: activeCast.value.name,
                                email: "noreply@nightshift.app"
                            };
                            try { 
                                await emailjs.send(emailConfig.serviceId, emailConfig.notificationTemplateId, params); 
                                alert("åº—é•·ã¸ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚"); 
                            } catch(e) { console.error(e); alert("ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: " + JSON.stringify(e)); }
                        }
                    } 
                };
                
                const remindAttendance = async (castId) => {
                    const c = storeData.value.casts.find(x=>x.id===castId);
                    if(!c) return;
                    if(confirm(`${c.name}ã•ã‚“ã«ã€Œå‡ºå‹¤ãƒªãƒã‚¤ãƒ³ãƒ‰ã€ã‚’é€ã‚Šã¾ã™ã‹ï¼Ÿ`)) {
                        const msg = { id:Date.now().toString(), text:`æœ¬æ—¥ã¯å‡ºå‹¤æ—¥ã§ã™ã€‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚`, isSenderCast:false, timestamp:new Date().toISOString(), castId:castId, isRead:false }; 
                        await updateStore({ messages: arrayUnion(msg) });
                        alert("é€ä¿¡ã—ã¾ã—ãŸï¼");
                    }
                };

                const sendMessage = () => sendMessageText(chatInput.value, !!activeCast.value);
                const sendMessageText = async (txt, isCast) => { if(!txt) return; const tid = isCast ? activeCast.value.id : viewingChatId.value; const msg = { id:Date.now().toString(), text:txt, isSenderCast:isCast, timestamp:new Date().toISOString(), castId:tid, isRead:false }; await updateStore({ messages: arrayUnion(msg) }); chatInput.value=''; };
                const uploadIcon = async (e) => { const file = e.target.files[0]; if(file && file.size < 100000) { const reader = new FileReader(); reader.onload = async (e) => { const base64 = e.target.result; if(activeCast.value) { const newCast = JSON.parse(JSON.stringify(activeCast.value)); newCast.icon = base64; await updateStore({ casts: arrayRemove(activeCast.value) }); await updateStore({ casts: arrayUnion(newCast) }); } else { await updateStore({ icon: base64 }); } }; reader.readAsDataURL(file); } else { alert("ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ (100KBä»¥ä¸‹)"); } };
                const openChat = (cid, n) => { viewingChatId.value=cid; markChatRead(); scrollToBottom(); };
                const closeChat = () => { viewingChatId.value = null; };
                const activeCast = computed(()=>storeData.value.casts.find(c=>c.id===currentCastId.value));
                const pageTitle = computed(()=>activeCast.value?'ã‚­ãƒ£ã‚¹ãƒˆ':'åº—èˆ—ç®¡ç†è€…');
                const pendingShifts = computed(()=>storeData.value.shifts.filter(s=>s.status==='æ‰¿èªå¾…ã¡' && s.type!=='æ¬ å‹¤').sort((a,b)=>new Date(a.date)-new Date(b.date)));
                const absenceShifts = computed(()=>storeData.value.shifts.filter(s=>s.status==='æ‰¿èªå¾…ã¡' && s.type==='æ¬ å‹¤').sort((a,b)=>new Date(a.date)-new Date(b.date)));
                const currentMessages = computed(()=>{ const tid = activeCast.value ? activeCast.value.id : viewingChatId.value; return storeData.value.messages.filter(m=>m.castId===tid).sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp)); });
                const totalUnread = computed(()=> { if(!activeCast.value) return 0; return storeData.value.messages.filter(m=>m.castId===activeCast.value.id && !m.isSenderCast && !m.isRead).length; });
                const getUnreadCount = (cid) => storeData.value.messages.filter(m=>m.castId===cid && m.isSenderCast && !m.isRead).length;
                const todayShifts = computed(() => { const today = formatLocal(new Date()); return storeData.value.shifts.filter(s => s.date === today && s.type === 'å‡ºå‹¤' && s.status === 'æ‰¿èªæ¸ˆã¿'); });
                const getStaffCount = (date) => storeData.value.shifts.filter(s => s.date === date && s.type === 'å‡ºå‹¤' && s.status === 'æ‰¿èªæ¸ˆã¿').length;
                const getDailyShifts = (date) => storeData.value.shifts.filter(s => s.date === date && s.type === 'å‡ºå‹¤' && s.status === 'æ‰¿èªæ¸ˆã¿');
                const sortedAnnouncements = computed(() => { if(!storeData.value.announcements) return []; return [...storeData.value.announcements].sort((a,b) => new Date(b.date) - new Date(a.date)); });
                const todaysMyShift = computed(() => { if(!activeCast.value) return null; const today = formatLocal(new Date()); return storeData.value.shifts.find(s => s.date === today && s.castId === activeCast.value.id && s.type === 'å‡ºå‹¤' && s.status === 'æ‰¿èªæ¸ˆã¿'); });
                const getMyMonthlyShifts = computed(() => { if(!activeCast.value) return []; const m = currentMonth.value.getMonth(); const y = currentMonth.value.getFullYear(); return storeData.value.shifts.filter(s => { const d = new Date(s.date); return d.getMonth() === m && d.getFullYear() === y && s.castId === activeCast.value.id && s.type === 'å‡ºå‹¤'; }).sort((a,b)=>new Date(a.date)-new Date(b.date)); });

                const next7Days = computed(() => {
                    const days = [];
                    for(let i=0; i<7; i++) {
                        const d = new Date();
                        d.setDate(d.getDate() + i);
                        days.push({ dateStr: formatLocal(d) });
                    }
                    return days;
                });

                const calendarDays = computed(() => { 
                    const year = currentMonth.value.getFullYear(); 
                    const month = currentMonth.value.getMonth(); 
                    const firstDay = new Date(year, month, 1); 
                    const lastDay = new Date(year, month + 1, 0); 
                    const days = []; 
                    for(let i=0; i<firstDay.getDay(); i++) days.push({ dateStr: '', isCurrentMonth: false }); 
                    for(let i=1; i<=lastDay.getDate(); i++) { 
                        const d = new Date(year, month, i); 
                        const str = formatLocal(d); 
                        days.push({ dateStr: str, isCurrentMonth: true }); 
                    } 
                    return days; 
                });

                const changeMonth = (n) => { const d = new Date(currentMonth.value); d.setMonth(d.getMonth() + n); currentMonth.value = d; };
                const goToToday = () => { currentMonth.value = new Date(); selectedDate.value = formatLocal(new Date()); };
                const currentMonthDisplay = computed(() => `${currentMonth.value.getFullYear()}å¹´ ${currentMonth.value.getMonth() + 1}æœˆ`);
                const todayStr = computed(() => formatLocal(new Date()));
                const selectDate=(d)=>{ if(!d) return; selectedDate.value=d; const s=getMyShift(d); editingShift.type=s?s.type:'å‡ºå‹¤'; editingShift.startTime=s?s.startTime:'20:00'; editingShift.endTime=s?s.endTime:'25:00'; editingShift.note=s?s.note:''; editingShift.backs = s && s.backs ? {...s.backs} : {}; };
                const getMyShift=(d)=>storeData.value.shifts.find(s=>s.date===d && s.castId===currentCastId.value);
                const getCastIcon = (cid) => { const c = storeData.value.casts.find(x=>x.id===cid); return c ? c.icon : null; };

                const salaryInfo = computed(() => { if(!activeCast.value) return {confirmed:0, pending:0}; const thisMonth = new Date().getMonth(); const myShifts = storeData.value.shifts.filter(s => s.castId === currentCastId.value && new Date(s.date).getMonth() === thisMonth && s.type === 'å‡ºå‹¤'); const hourly = activeCast.value.settings?.hourlyRate || 0; const backOpts = storeData.value.backOptions || []; const calc = (shifts) => { let total = 0; shifts.forEach(s => { const start = parseInt(s.startTime.split(':')[0]) + parseInt(s.startTime.split(':')[1])/60; const end = parseInt(s.endTime.split(':')[0]) + parseInt(s.endTime.split(':')[1])/60; total += (end - start) * hourly; if(s.backs) { Object.keys(s.backs).forEach(oid=>{const c=parseInt(s.backs[oid]); const o=backOpts.find(x=>x.id===oid); if(o) total+=c*o.price;}); } }); return Math.floor(total); }; return { confirmed: calc(myShifts.filter(s => s.status === 'æ‰¿èªæ¸ˆã¿')), pending: calc(myShifts.filter(s => s.status === 'æ‰¿èªå¾…ã¡')) }; });
                const toggleSalaryDisplay=async()=>{ const newCast = JSON.parse(JSON.stringify(activeCast.value)); if(!newCast.settings) newCast.settings={hourlyRate:2000, showSalary:true}; newCast.settings.showSalary = !newCast.settings.showSalary; await updateStore({ casts: arrayRemove(activeCast.value) }); await updateStore({ casts: arrayUnion(newCast) }); };
                const saveCastSettings=async()=>{ const newCast = JSON.parse(JSON.stringify(activeCast.value)); await updateStore({ casts: arrayRemove(activeCast.value) }); await updateStore({ casts: arrayUnion(newCast) }); };
                const showQRCode=(c)=>{ qrTargetName.value=c.name; qrUrl.value=`${window.location.origin}${window.location.pathname}?store=${storeData.value.storeDisplayId}&code=${c.code}`; showQRModal.value=true; };
                const openFeedback = () => { window.location.href = `mailto:NightShiftPro.app@gmail.com?subject=NightShiftProä¸å…·åˆå ±å‘Š&body=åº—èˆ—ID:${storeData.value.storeDisplayId}`; };
                const formatDate=(d)=>new Date(d).toLocaleDateString('ja-JP',{month:'numeric',day:'numeric',weekday:'short'});
                const formatDateTime=(t)=> { const d = new Date(t); return `${d.toLocaleDateString('ja-JP')} ${d.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'})}`; };
                const formatTime=(t)=>t.includes('T') ? new Date(t).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}) : t;
                const isSameDay=(a,b)=>a===b;
                const getShiftColor=(s)=>{if(s.type==='æ¬ å‹¤')return 'bg-purple-500';if(s.status==='æ‰¿èªå¾…ã¡')return 'bg-blue-300 animate-pulse-slow';if(s.type==='ä¼‘ã¿')return 'bg-red-500';return 'bg-blue-500';};
                const getLastMsg=(cid)=>{const m=storeData.value.messages.filter(x=>x.castId===cid);return m.length?m[m.length-1].text:'';};
                const isMyMessage=(m)=>{if(activeCast.value)return m.isSenderCast;return !m.isSenderCast;};

                watch(() => [currentTab.value, viewingChatId.value], () => { if (currentTab.value === 'messages' || viewingChatId.value) scrollToBottom(); });
                watch(() => currentMessages.value.length, () => { if (currentTab.value === 'messages' || viewingChatId.value) scrollToBottom(); });

                return { isLoading, isFirstRun, isLoggedIn, isStaffLoginMode, isSuperAdmin, allStoresList, deleteStoreForce, currentTab, viewingChatId, staffIdInput, staffPassInput, storeIdInput, castCodeInput, newStoreName, newStoreEmail, chatInput, storeData, activeCast, pageTitle, pendingShifts, absenceShifts, calendarDays, selectedDate, currentMonthDisplay, editingShift, currentMessages, registerStore, loginStaff, loginCast, logout, showAnnouncementModal, newAnnouncementText, postAnnouncement, deleteAnnouncement, showRegisterModal, showBackSettings, newBackName, newBackPrice, addBackOption, deleteBackOption, selectDate, changeMonth, goToToday, todayStr, getShiftColor, getMyShift, getDailyShifts, submitShift, updateShift, reportAbsence, confirmAttendance, openChat, closeChat, sendMessage, isMyMessage, getLastMsg, formatTime, formatDate, formatDateTime, isSameDay, salaryInfo, toggleSalaryDisplay, saveCastSettings, addCast, deleteCast, showQRModal, qrUrl, qrTargetName, showQRCode, showHelpModal, openFeedback, totalUnread, getUnreadCount, todayShifts, getStaffCount, getCastIcon, uploadIcon, selectedNews, openNews, confirmNews, markChatRead, updateStore, sortedAnnouncements, todaysMyShift, getMyMonthlyShifts, remindAttendance, next7Days, fetchAllStores };
            }
        }).mount('#app');
    </script>
</body>
</html>
